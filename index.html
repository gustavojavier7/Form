<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reporte CCTV ‚Äì Formato Planilla</title>
  
  <!-- Librer√≠as para exportar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    /* --- Configuraci√≥n general Word-like --- */
    :root{
      --ink:#000;
      --grid:#000;
    }
    body{
      margin:0;
      background:#fff;
      color:var(--ink);
      font-family: Calibri, Arial, sans-serif;
      font-size: 11pt;
    }
    .page{
      width: 210mm;
      min-height: 297mm;
      margin: 10mm auto;
      padding: 0;
      box-sizing: border-box;
      border: 1px solid #000;
    }
    .page-content{
      padding: 12mm;
    }

    /* --- Tabla principal --- */
    table.form{
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    table.form td, table.form th{
      border: 1px solid var(--grid);
      padding: 4px 6px;
      vertical-align: middle;
      line-height: 1.15;
    }

    /* Alturas fijas para consistencia */
    .rH1 td{ height: 78px; }
    
    /* Fila compacta */
    .rowCompact td{ height: 26px; }
    
    /* Encabezado complejo */
    .logoCell{
      text-align: left;
      vertical-align: middle;
    }
    .logoPlaceholder{
      width: 100%;
      height: 40px;
      border: 1px dashed #999;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9pt;
      color: #666;
    }
    .titleCell{
      text-align: center;
      font-weight: 700;
      letter-spacing: 0.5px;
      font-size: 14pt;
    }
    .metaCell{
      text-align: center;
      vertical-align: middle;
    }
    .metaTable{
      width: 100%;
      border-collapse: collapse;
    }
    .metaTable td{
      border: none;
      padding: 1px 4px;
      text-align: left;
      height: auto;
    }
    .metaLabel{
      font-weight: 700;
      width: 40%;
    }
    .metaValue{
      font-weight: 400;
      width: 60%;
    }
    
    /* Labels y valores */
    .rowLabel{
      font-weight: 700;
    }
    .value{
      font-weight: 400;
    }
    
    /* Select field estilo Word */
    .select-field{
      width: 100%;
      border: none;
      background: transparent;
      font: inherit;
      color: inherit;
      padding: 0;
      line-height: 1.15;
      appearance: none;
      -webkit-appearance: none;
      cursor: pointer;
    }
    
    .select-field:focus{
      outline: none;
      background-color: #f0f8ff;
    }
    
    /* Input de texto estilo Word */
    .text-input{
      width: 100%;
      border: none;
      background: transparent;
      font: inherit;
      color: inherit;
      padding: 0;
      line-height: 1.15;
      box-sizing: border-box;
    }
    
    .text-input:focus{
      outline: none;
      background-color: #f0f8ff;
    }
    
    .text-input.invalid{
      border: 2px solid #dc3545;
      padding: 2px;
      background-color: #fff5f5;
    }
    
    /* Select con validaci√≥n */
    .select-field.invalid{
      border: 2px solid #dc3545;
      padding: 2px;
      background-color: #fff5f5;
    }
    
    /* Date input con validaci√≥n */
    .date-input.invalid{
      border: 2px solid #dc3545;
      padding: 2px;
      background-color: #fff5f5;
    }
    
    /* Textarea con validaci√≥n */
    .novedades-textarea.invalid{
      border: 2px solid #dc3545;
      background-color: #fff5f5;
    }

    .validation-messages{
      display: none;
      margin-top: 10px;
      padding: 8px 10px;
      border: 1px solid #dc3545;
      background-color: #fff5f5;
      color: #b02a37;
      font-size: 10pt;
      line-height: 1.4;
    }

    .validation-messages ul{
      margin: 0;
      padding-left: 18px;
    }
    
    /* Protecci√≥n contra wrap */
    .oneline{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Celda fecha: sin padding extra */
    .dateValueCell{
      text-align: center;
      padding: 0 !important;
    }
    
    /* Contenedor simple: no debe sumar altura */
    .date-input-container{
      width: 100%;
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    /* Input date "Word-like" */
    .date-input{
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      
      border: 0;
      background: transparent;
      font: inherit;
      color: inherit;
      
      text-align: center;
      padding: 0;
      line-height: 26px; /* Altura de la fila compacta para centrado vertical */
      
      appearance: none;
      -webkit-appearance: none;
      
      cursor: pointer;
    }
    
    /* Solo un highlight suave al foco */
    .date-input:focus{
      outline: none;
      background-color: #f0f8ff;
    }
    
    /* Radios con estilo "checkbox" */
    .cb-option{
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      user-select: none;
    }

    .cb-input{
      position: absolute;
      opacity: 0;
      width: 1px;
      height: 1px;
    }

    .cb{
      display:inline-block;
      width: 12px;
      height: 12px;
      border: 1.5px solid #000;
      margin-left: 4px;
      margin-right: 8px;
      vertical-align: middle;
      position: relative;
      transition: background-color 0.1s ease;
    }

    .cb-option:hover .cb{
      background-color: #f0f0f0;
    }

    .cb-input:focus-visible + .cb{
      outline: 2px solid #0066cc;
      outline-offset: 2px;
    }

    .cb-input:checked + .cb::after{
      content:"X";
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      font-size: 10px;
      font-weight: bold;
    }
    
    /* Opciones en l√≠nea */
    .opts{
      display: flex;
      gap: 15px;
      flex-wrap: nowrap;
      align-items: center;
    }
    .opts > label{
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }
    .opts-spread{
      justify-content: space-between;
      gap: 0;
    }
    
    /* Secci√≥n Novedades */
    .sectionTitle{
      font-weight: 700;
      background-color: #f0f0f0;
      padding: 6px !important;
    }
    .bigBox{
      vertical-align: top !important;
      padding: 8px !important;
    }
    
    /* Textarea para novedades */
    .novedades-textarea{
      width: 100%;
      min-height: 150px;
      border: 1px solid #ccc;
      padding: 8px;
      font-family: Calibri, Arial, sans-serif;
      font-size: 11pt;
      line-height: 1.5;
      resize: vertical;
      box-sizing: border-box;
      background-color: #fff;
    }
    
    .novedades-textarea:focus{
      outline: none;
      border-color: #0066cc;
      background-color: #f0f8ff;
    }
    
    /* Secci√≥n de carga de im√°genes - Segunda p√°gina */
    .image-upload-area{
      padding: 15px;
    }
    
    .upload-prompt{
      border: 2px dashed #999;
      padding: 20px;
      text-align: center;
      background-color: #f9f9f9;
      margin-bottom: 20px;
    }
    
    #bulkImageUpload{
      padding: 8px;
      font-size: 10pt;
      cursor: pointer;
    }
    
    /* Contenedor de im√°genes cargadas */
    #loadedImagesContainer{
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    
    .loaded-image-item{
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #fff;
      position: relative;
      page-break-inside: avoid;
    }
    
    .loaded-image-item img{
      width: 100%;
      height: auto;
      display: block;
      border: 1px solid #ddd;
    }
    
    .loaded-image-caption{
      margin-top: 8px;
      font-size: 10pt;
      color: #333;
      text-align: center;
      font-weight: 600;
    }
    
    .loaded-image-remove{
      position: absolute;
      top: 15px;
      right: 15px;
      width: 28px;
      height: 28px;
      background-color: rgba(220, 53, 69, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
      z-index: 10;
    }
    
    .loaded-image-remove:hover{
      background-color: rgba(200, 35, 51, 1);
    }
    
    /* Bot√≥n exportar PDF */
    .export-section{
      margin-top: 15px;
      text-align: center;
      padding: 10px 0;
    }
    
    .export-pdf-btn{
      background-color: #0066cc;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 11pt;
      font-family: Calibri, Arial, sans-serif;
      font-weight: 600;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .export-pdf-btn:hover{
      background-color: #0052a3;
    }
    
    .export-pdf-btn:active{
      background-color: #004080;
      transform: translateY(1px);
    }
    
    .export-pdf-btn:disabled{
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    /* Firmas */
    .signatureSection{
      margin-top: 20px;
      border-top: 2px solid #000;
      padding-top: 10px;
    }
    .signatureTable{
      width: 100%;
      border-collapse: collapse;
    }
    .signatureCell{
      padding: 10px;
      vertical-align: top;
      width: 50%;
    }
    .signatureLine{
      border-top: 1px solid #000;
      margin-top: 40px;
      padding-top: 4px;
      font-size: 10pt;
      text-align: center;
    }
    
    /* Pie */
    .footerNote{
      margin-top: 15mm;
      font-size: 9pt;
      text-align: center;
      border-top: 1px solid #ccc;
      padding-top: 5px;
    }
    
    /* Impresi√≥n */
    @media print{
      .page{
        margin: 0;
        border: none;
        page-break-after: always;
      }
      body{
        background:#fff;
      }
      .logoPlaceholder{
        border: 1px solid #ddd;
      }
      .date-input {
        -webkit-appearance: none;
        appearance: none;
      }
      .date-input::-webkit-calendar-picker-indicator {
        display: none;
      }
      .select-field{
        appearance: none;
        -webkit-appearance: none;
      }
      .text-input{
        border: none;
        background: transparent;
      }
      .novedades-textarea{
        border: 1px solid #ccc;
        background: transparent;
      }
      .cb{
        cursor: default;
      }
      .cb:hover{
        background-color: transparent;
      }
      .export-section{
        display: none !important;
      }
      .upload-prompt{
        display: none !important;
      }
      .loaded-image-remove{
        display: none !important;
      }
      #bulkImageUpload, #hashFileInputs{
        display: none !important;
      }
      #calculateHashBtn{
        display: none !important;
      }
      /* Eliminar bordes de validaci√≥n en impresi√≥n */
      .invalid{
        border: none !important;
        background: transparent !important;
      }
      .text-input.invalid,
      .select-field.invalid,
      .date-input.invalid,
      .novedades-textarea.invalid{
        border: none !important;
        background: transparent !important;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="page-content">
      <table class="form" aria-label="Reporte de CCTV">
        <!-- Colgroup para estabilizar columnas -->
        <colgroup>
          <col style="width:20%">
          <col style="width:40%">
          <col style="width:15%">
          <col style="width:25%">
        </colgroup>
        
        <!-- Encabezado -->
        <tr class="rH1">
          <td class="logoCell">
            <img src="logo.png" alt="Logo Mondelez" style="width: 100%; max-height: 70px; object-fit: contain; display: block;">
          </td>
          <td class="titleCell">REPORTE DE CCTV</td>
          <td class="metaCell" colspan="2">
            <table class="metaTable">
              <tr><td class="metaLabel">C√≥digo</td><td class="metaValue">RE PAC PO GS 4.4.6 31-01</td></tr>
              <tr><td class="metaLabel">Fecha del formulario</td><td class="metaValue">19-03-2018</td></tr>
              <tr><td class="metaLabel">Revisi√≥n</td><td class="metaValue">09</td></tr>
            </table>
          </td>
        </tr>

        <!-- Reportado por y Fecha de eventos -->
        <tr class="rowCompact">
          <td class="rowLabel">Reportado por</td>
          <td class="value">
            <select class="select-field" id="reportadoPor">
              <option value="" selected disabled>Choose an item.</option>
              <option>G. L√≥pez</option>
              <option>E. Sosa</option>
              <option>J. Castilla</option>
              <option>J. Mart√≠n</option>
            </select>
          </td>
          <td class="rowLabel" style="text-align:center;">Fecha de eventos</td>
          <td class="dateValueCell">
            <div class="date-input-container">
              <input type="date" id="fechaEventos" class="date-input" value="">
            </div>
          </td>
        </tr>

        <!-- Tipo de Reporte - CHECKBOXES INTERACTIVOS -->
        <tr>
          <td class="rowLabel">Tipo de Reporte</td>
          <td class="value" colspan="3">
            <div class="opts opts-spread">
              <label class="cb-option">
                Caso
                <input class="cb-input" type="radio" name="tipoReporte" value="caso">
                <span class="cb" aria-hidden="true"></span>
              </label>
              <label class="cb-option">
                Monitoreo
                <input class="cb-input" type="radio" name="tipoReporte" value="monitoreo">
                <span class="cb" aria-hidden="true"></span>
              </label>
              <label class="cb-option">
                Novedades
                <input class="cb-input" type="radio" name="tipoReporte" value="novedades" checked>
                <span class="cb" aria-hidden="true"></span>
              </label>
              <label class="cb-option">
                Investigaci√≥n
                <input class="cb-input" type="radio" name="tipoReporte" value="investigacion">
                <span class="cb" aria-hidden="true"></span>
              </label>
              <label class="cb-option">
                Auditor√≠a
                <input class="cb-input" type="radio" name="tipoReporte" value="auditoria">
                <span class="cb" aria-hidden="true"></span>
              </label>
            </div>
          </td>
        </tr>

        <!-- Sitio / Caso ID -->
        <tr>
          <td class="rowLabel">Sitio</td>
          <td class="value oneline">PLANTA PACHECO</td>
          <td class="rowLabel" style="text-align:center;">Reporte ID</td>
          <td class="value oneline">
            <input type="text" id="casoId" class="text-input" value="" maxlength="19" placeholder="[Auto-generado]">
          </td>
        </tr>

        <!-- Eventos registrados / √Årea - CHECKBOXES INTERACTIVOS -->
        <tr>
          <td class="rowLabel">1.- ¬øPreservar evidencia?</td>
          <td class="value">
            <div class="opts">
              <label class="cb-option">
                S√≠
                <input class="cb-input" type="radio" name="eventosRegistrados" value="si">
                <span class="cb" aria-hidden="true"></span>
              </label>
              <label class="cb-option">
                No
                <input class="cb-input" type="radio" name="eventosRegistrados" value="no" checked>
                <span class="cb" aria-hidden="true"></span>
              </label>
            </div>
          </td>
          <td class="rowLabel">2.- √Årea de los eventos:</td>
          <td class="value oneline">
            <input type="text" id="areaEventos" class="text-input" value="" maxlength="50" placeholder="[Escribir √Årea]">
          </td>
        </tr>

        <!-- Novedades -->
        <tr>
          <td class="sectionTitle" colspan="4">4.- Novedades:</td>
        </tr>
        <tr>
          <td class="bigBox" colspan="4">
            <textarea id="novedadesText" class="novedades-textarea" rows="10" placeholder="[Escriba Novedades]"></textarea>
          </td>
        </tr>
      </table>

      <div id="validationMessages" class="validation-messages" role="alert" aria-live="polite"></div>

      <!-- Secci√≥n de firmas -->
      <div class="signatureSection">
        <table class="signatureTable">
          <tr>
            <td class="signatureCell">
              <div class="signatureLine">
                Reporte generado por<br>
                <span id="reporteGeneradoPor">Choose an item.</span>
              </div>
            </td>
            <td class="signatureCell">
              <div class="signatureLine">
                Reporte revisado por<br>
                G. LOPEZ
              </div>
            </td>
          </tr>
        </table>
      </div>

      <!-- Secci√≥n de Preservaci√≥n de Evidencia (condicional) -->
      <div id="preservacionSection" style="border-top: 2px solid #000; margin-top: 20px; padding-top: 20px; display: none;">
        <h3 style="font-size: 12pt; font-weight: 700;">PRESERVACI√ìN DE LA EVIDENCIA</h3>
        <div class="upload-prompt">
          <p style="font-weight: 700; margin-bottom: 10px;">Cargar archivos para Cadena de Custodia (Video/Fotos):</p>
          <input type="file" id="hashFileInputs" multiple style="margin-bottom: 10px;">
          <br>
          <button id="calculateHashBtn" class="export-pdf-btn" style="background-color: #28a745; margin-top: 10px;">üîí Calcular Hash SHA-256</button>
          <p style="font-size: 9pt; color: #666; margin-top: 8px;">*Calcula el hash SHA-256 de todos los archivos de fotograf√≠a y video</p>
        </div>
        
        <div id="cadenaCustodiaContainer" style="margin-top: 20px; display: none;">
          <h3 style="font-size: 11pt; font-weight: 700; border-bottom: 1px solid #000; padding-bottom: 5px;">CADENA DE CUSTODIA (HASH SHA-256)</h3>
          <table class="form" id="hashTable" style="font-size: 9pt; margin-top: 10px;">
            <thead>
              <tr style="background-color: #f0f0f0;">
                <th style="width: 40%;">Nombre del Archivo</th>
                <th style="width: 60%;">Hash SHA-256</th>
              </tr>
            </thead>
            <tbody id="hashTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="footerNote">Mondelez International Internal ‚Äî Uso exclusivo</div>
    </div>
  </div>

  <!-- SEGUNDA P√ÅGINA: Im√°genes CCTV -->
  <div class="page" id="imagesPage">
    <div class="page-content">
      <h2 style="text-align: center; margin-bottom: 20px; font-size: 14pt; font-weight: 700;">EVIDENCIA FOTOGR√ÅFICA - IM√ÅGENES CCTV</h2>
      
      <!-- √Årea para cargar im√°genes -->
      <div class="image-upload-area">
        <div class="upload-prompt">
          <p style="font-weight: 700; margin-bottom: 10px;">Cargar im√°genes de evidencia CCTV:</p>
          <input type="file" id="bulkImageUpload" accept="image/png, image/jpeg, image/jpg" multiple style="margin-bottom: 15px;">
          <p style="font-size: 9pt; color: #666; margin-top: 5px;">Formatos permitidos: PNG, JPG. Puede seleccionar m√∫ltiples archivos.</p>
        </div>
        
        <!-- Contenedor donde se mostrar√°n las im√°genes cargadas -->
        <div id="loadedImagesContainer"></div>
      </div>

      <!-- Bot√≥n de exportar a PDF -->
      <div class="export-section">
        <button id="exportPdfBtn" class="export-pdf-btn">üìÑ Exportar a PDF</button>
      </div>

      <div class="footerNote">Mondelez International Internal ‚Äî Uso exclusivo</div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ========== DECLARACI√ìN DE VARIABLES ==========
      const fechaInput = document.getElementById('fechaEventos');
      const reportadoPorSelect = document.getElementById('reportadoPor');
      const reporteGeneradoPorSpan = document.getElementById('reporteGeneradoPor');
      const exportPdfBtn = document.getElementById('exportPdfBtn');
      const casoIdInput = document.getElementById('casoId');
      const areaEventosInput = document.getElementById('areaEventos');
      const novedadesTextarea = document.getElementById('novedadesText');
      const bulkImageUpload = document.getElementById('bulkImageUpload');
      const loadedImagesContainer = document.getElementById('loadedImagesContainer');
      const preservacionSection = document.getElementById('preservacionSection');
      const calculateHashBtn = document.getElementById('calculateHashBtn');
      const hashFileInputs = document.getElementById('hashFileInputs');
      const hashTableBody = document.getElementById('hashTableBody');
      const cadenaCustodiaContainer = document.getElementById('cadenaCustodiaContainer');
      const validationMessages = document.getElementById('validationMessages');
      
      let loadedImages = []; // Array para almacenar las im√°genes cargadas
      let hashEntries = [];

      // ========== FUNCI√ìN PARA FORMATEAR FECHA ==========
      function formatearFechaDisplay(fechaISO) {
        if (!fechaISO) return '';
        const partes = fechaISO.split('-');
        return `${partes[2]}-${partes[1]}-${partes[0]}`; // DD-MM-YYYY
      }

      // Configurar t√≠tulo del input de fecha
      fechaInput.title = 'Haz clic para seleccionar una fecha';

      // ========== SINCRONIZACI√ìN REPORTADO POR ==========
      
      function updateReporteGeneradoPor() {
        const selectedValue = reportadoPorSelect.value;
        reporteGeneradoPorSpan.textContent = selectedValue || 'Choose an item.';
        console.log('Reportado por actualizado:', selectedValue);
      }

      // ========== GENERACI√ìN AUTOM√ÅTICA DE REPORTE ID ==========
      
      function generateReporteId() {
        // Obtener timestamp Unix en milisegundos
        const timestampMs = Date.now();
        
        // Convertir a string y asegurar 16 d√≠gitos
        let timestampStr = timestampMs.toString();
        
        // Si tiene menos de 16 d√≠gitos, rellenar con el timestamp en microsegundos (simulado)
        if (timestampStr.length < 16) {
          // Agregar d√≠gitos adicionales basados en performance.now() para mayor precisi√≥n
          const microPrecision = Math.floor((performance.now() % 1) * 1000000).toString().padStart(6, '0');
          timestampStr = timestampStr + microPrecision.substring(0, 16 - timestampStr.length);
        }
        
        // Tomar exactamente 16 d√≠gitos
        timestampStr = timestampStr.substring(0, 16);
        
        // Formatear como 0000-0000-0000-0000
        const reporteId = timestampStr.match(/.{1,4}/g).join('-');
        
        return reporteId;
      }
      
      // Generar Reporte ID autom√°ticamente al cargar la p√°gina
      if (!casoIdInput.value || casoIdInput.value.trim() === '') {
        const nuevoReporteId = generateReporteId();
        casoIdInput.value = nuevoReporteId;
        console.log('Reporte ID generado autom√°ticamente:', nuevoReporteId);
        validateForm(); // Validar despu√©s de generar
      }
      
      // Bot√≥n para regenerar Reporte ID manualmente
      const regenerarIdBtn = document.createElement('button');
      regenerarIdBtn.textContent = 'üîÑ';
      regenerarIdBtn.title = 'Generar nuevo Reporte ID';
      regenerarIdBtn.className = 'export-pdf-btn';
      regenerarIdBtn.style.cssText = 'background-color: #6c757d; padding: 4px 8px; font-size: 9pt; margin-left: 5px; display: inline-block; vertical-align: middle;';
      regenerarIdBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const nuevoReporteId = generateReporteId();
        casoIdInput.value = nuevoReporteId;
        console.log('Reporte ID regenerado:', nuevoReporteId);
        validateForm();
      });
      
      // Insertar el bot√≥n junto al input
      casoIdInput.parentElement.appendChild(regenerarIdBtn);

      // ========== VALIDACI√ìN DEL FORMULARIO ==========
      
      function validateForm() {
        const fieldRules = [
          { key: 'fechaEventos', el: fechaInput, valid: el => el.value.trim() !== '', msg: 'Seleccione fecha.' },
          { key: 'reportadoPor', el: reportadoPorSelect, valid: el => el.value.trim() !== '', msg: 'Seleccione qui√©n reporta.' },
          { key: 'casoId', el: casoIdInput, valid: el => el.value.trim() !== '', msg: 'Ingrese el Reporte ID.' },
          { key: 'areaEventos', el: areaEventosInput, valid: el => el.value.trim() !== '', msg: 'Ingrese el √°rea de los eventos.' },
          { key: 'novedades', el: novedadesTextarea, valid: el => el.value.trim() !== '', msg: 'Ingrese las novedades.' }
        ];

        const preservacionSeleccionada = document.querySelector('input[name="eventosRegistrados"]:checked');
        const siPreservarChecked = preservacionSeleccionada?.value === 'si';
        const preservacionRule = {
          key: 'preservacion',
          valid: () => !siPreservarChecked || hashEntries.length > 0,
          msg: 'Debe calcular al menos un hash para preservar evidencia.'
        };

        const errors = [];

        fieldRules.forEach(rule => {
          const isValid = rule.valid(rule.el);
          rule.el.classList.toggle('invalid', !isValid);
          if (!isValid) {
            errors.push(rule.msg);
          }
        });

        if (!preservacionRule.valid()) {
          errors.push(preservacionRule.msg);
        }

        const formularioValido = errors.length === 0;
        
        if (formularioValido) {
          exportPdfBtn.disabled = false;
          exportPdfBtn.style.backgroundColor = '#0066cc';
          exportPdfBtn.style.cursor = 'pointer';
        } else {
          exportPdfBtn.disabled = true;
          exportPdfBtn.style.backgroundColor = '#cccccc';
          exportPdfBtn.style.cursor = 'not-allowed';
        }

        renderValidationMessages(errors);
        
        return formularioValido;
      }

      function renderValidationMessages(errors) {
        if (!validationMessages) return;

        if (errors.length === 0) {
          validationMessages.style.display = 'none';
          validationMessages.innerHTML = '';
          return;
        }

        const items = errors.map(error => `<li>${error}</li>`).join('');
        validationMessages.innerHTML = `<strong>Faltan campos obligatorios:</strong><ul>${items}</ul>`;
        validationMessages.style.display = 'block';
      }
      
      const trackedFields = new Set([
        fechaInput,
        reportadoPorSelect,
        casoIdInput,
        areaEventosInput,
        novedadesTextarea
      ]);

      function handleFormInteraction(event) {
        const { target, type } = event;
        if (!(target instanceof HTMLElement)) return;

        if (target === reportadoPorSelect && type === 'change') {
          updateReporteGeneradoPor();
        }

        if (target instanceof HTMLInputElement && target.name === 'eventosRegistrados' && type === 'change') {
          const valor = target.value;
          if (valor === 'si') {
            preservacionSection.style.display = 'block';
          } else {
            preservacionSection.style.display = 'none';
            hashEntries = [];
            hashTableBody.innerHTML = '';
            cadenaCustodiaContainer.style.display = 'none';
          }
        }

        if (trackedFields.has(target) || (target instanceof HTMLInputElement && target.name === 'eventosRegistrados')) {
          validateForm();
        }
      }

      function handleFieldFocus(event) {
        const { target } = event;
        if (trackedFields.has(target)) {
          target.classList.remove('invalid');
        }
      }

      document.addEventListener('input', handleFormInteraction);
      document.addEventListener('change', handleFormInteraction);
      document.addEventListener('focusin', handleFieldFocus);
      document.addEventListener('focusout', handleFormInteraction);
      
      // Validaci√≥n inicial al cargar la p√°gina
      updateReporteGeneradoPor();
      validateForm();

      // ========== MANEJO DE IM√ÅGENES - CARGA M√öLTIPLE ==========

      bulkImageUpload.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        
        files.forEach(file => {
          if (file && (file.type === 'image/png' || file.type === 'image/jpeg' || file.type === 'image/jpg')) {
            const reader = new FileReader();
            
            reader.onload = (event) => {
              const imageData = {
                id: Date.now() + Math.random(), // ID √∫nico
                src: event.target.result,
                fileName: file.name,
                timestamp: new Date().toLocaleString('es-AR')
              };
              
              loadedImages.push(imageData);
              renderImages();
              console.log(`Imagen cargada: ${file.name}`);
            };
            
            reader.readAsDataURL(file);
          } else {
            alert(`El archivo ${file.name} no es una imagen PNG o JPG v√°lida`);
          }
        });
        
        // Resetear el input para permitir cargar las mismas im√°genes nuevamente si es necesario
        bulkImageUpload.value = '';
      });

      // Funci√≥n para renderizar todas las im√°genes
      function renderImages() {
        loadedImagesContainer.innerHTML = '';
        
        loadedImages.forEach((imageData, index) => {
          const imageItem = document.createElement('div');
          imageItem.className = 'loaded-image-item';
          imageItem.dataset.imageId = imageData.id;
          
          imageItem.innerHTML = `
            <button class="loaded-image-remove" data-image-id="${imageData.id}" title="Eliminar imagen">√ó</button>
            <img src="${imageData.src}" alt="${imageData.fileName}">
            <div class="loaded-image-caption">
              Imagen ${index + 1}: ${imageData.fileName}
            </div>
          `;
          
          loadedImagesContainer.appendChild(imageItem);
        });
        
        // Agregar event listeners a los botones de eliminar
        document.querySelectorAll('.loaded-image-remove').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const imageId = parseFloat(e.target.dataset.imageId);
            loadedImages = loadedImages.filter(img => img.id !== imageId);
            renderImages();
            console.log('Imagen eliminada');
          });
        });
      }

      // ========== C√ÅLCULO DE HASH SHA-256 ==========

      async function computeSHA256(file) {
        const buffer = await file.arrayBuffer();
        const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      }

      calculateHashBtn.addEventListener('click', async () => {
        const files = Array.from(hashFileInputs.files);
        if (files.length === 0) {
          alert('Por favor, selecciona archivos primero.');
          return;
        }

        calculateHashBtn.disabled = true;
        calculateHashBtn.textContent = '‚åõ Calculando...';
        hashTableBody.innerHTML = '';
        hashEntries = [];
        cadenaCustodiaContainer.style.display = 'block';

        for (const file of files) {
          const hash = await computeSHA256(file);
          hashEntries.push({ name: file.name, hash });
          const row = `<tr>
            <td style="word-break: break-all;">${file.name}</td>
            <td style="font-family: monospace; word-break: break-all;">${hash}</td>
          </tr>`;
          hashTableBody.insertAdjacentHTML('beforeend', row);
        }

        calculateHashBtn.disabled = false;
        calculateHashBtn.textContent = 'üîí Calcular Hash SHA-256';
        validateForm(); // Revalida para habilitar el bot√≥n de exportaci√≥n
        alert('C√°lculo de hashes completado e insertado en el reporte.');
      });

      // ========== FUNCIONES AUXILIARES PARA PAGINACI√ìN ==========
      /**
       * Crea una p√°gina temporal para la tabla de hashes
       * @param {number} pageIndex - N√∫mero de p√°gina (para encabezado "Continuaci√≥n")
       * @returns {HTMLElement} - Elemento div con estructura de p√°gina A4
       */
      function createHashTempPage(pageIndex) {
        const div = document.createElement('div');
        div.className = 'page hash-temp-page';
        div.style.position = 'absolute';
        div.style.top = '-9999px';
        div.style.left = '0';
        div.style.width = '210mm';
        div.style.minHeight = '297mm';
        div.style.padding = '0';
        div.style.boxSizing = 'border-box';
        div.style.border = '1px solid #000';
        div.style.backgroundColor = '#fff';
        div.dataset.pageIndex = pageIndex;

        div.innerHTML = `
          <div class="page-content">
            <h3 style="text-align:center; font-size:12pt; font-weight:700; margin-bottom:10px; margin-top:0;">
              CADENA DE CUSTODIA (HASH SHA-256)${pageIndex > 1 ? ` - Continuaci√≥n ${pageIndex - 1}` : ''}
            </h3>
            <table class="form" style="font-size: 9pt; margin-bottom: 20px;">
              <thead>
                <tr style="background-color: #f0f0f0;">
                  <th style="width: 40%; border: 1px solid #000; padding: 4px 6px;">Nombre del Archivo</th>
                  <th style="width: 60%; border: 1px solid #000; padding: 4px 6px;">Hash SHA-256</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="footerNote" style="position: absolute; bottom: 5mm; left: 12mm; right: 12mm; font-size: 9pt; text-align: center; border-top: 1px solid #ccc; padding-top: 5px;">
              Mondelez International Internal ‚Äî Uso exclusivo
            </div>
          </div>
        `;
        return div;
      }

      /**
       * Captura un elemento DOM y lo agrega al PDF
       * @param {jsPDF} pdf - Instancia de jsPDF
       * @param {HTMLElement} element - Elemento a capturar
       * @param {number} pageWidth - Ancho de p√°gina en mm
       * @param {number} pageHeight - Alto de p√°gina en mm
       * @param {boolean} addNewPage - Si debe agregar nueva p√°gina al PDF
       */
      async function addPageToPdf(pdf, element, pageWidth, pageHeight, addNewPage) {
        if (addNewPage) pdf.addPage();

        const canvas = await html2canvas(element, {
          scale: 2,
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff',
          windowWidth: element.scrollWidth,
          windowHeight: element.scrollHeight
        });

        const imgData = canvas.toDataURL('image/png');
        const imgWidth = pageWidth;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
      }

      // ========== EXPORTAR A PDF CON PAGINACI√ìN INTELIGENTE ==========
      // ========== EXPORTAR A PDF CON PAGINACI√ìN INTELIGENTE ==========
exportPdfBtn.addEventListener('click', async () => {
  // Validaci√≥n previa
  if (!validateForm()) {
    alert('Por favor, complete todos los campos obligatorios.');
    return;
  }
  
  // Deshabilitar bot√≥n y mostrar progreso
  exportPdfBtn.disabled = true;
  exportPdfBtn.textContent = '‚è≥ Generando PDF...';
  
  // Guardar referencias a elementos UI
  const uiElements = {
    exportSection: document.querySelector('.export-section'),
    removeButtons: document.querySelectorAll('.loaded-image-remove'),
    uploadPrompts: document.querySelectorAll('.upload-prompt'),
    hashBtn: document.getElementById('calculateHashBtn'),
    hashInput: document.getElementById('hashFileInputs'),
    bulkInput: document.getElementById('bulkImageUpload')
  };
  
  // Ocultar elementos UI temporalmente
  hideUIElements(uiElements);
  
  // Formatear fecha para visualizaci√≥n
  const fechaOriginal = fechaInput.value;
  const fechaFormateada = formatearFechaDisplay(fechaOriginal);
  const tempFechaElement = createTempDateDisplay(fechaFormateada);
  replaceDateInput(fechaInput, tempFechaElement);
  
  try {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
      orientation: 'portrait',
      unit: 'mm',
      format: 'a4'
    });
    
    // Configuraci√≥n de p√°gina
    const PAGE_CONFIG = {
      width: 210,
      height: 297,
      maxContentHeight: 260, // Altura m√°xima de contenido (dejando m√°rgenes)
      rowHeight: 8 // Altura aproximada de una fila en mm
    };
    
    // 1. PROCESAR P√ÅGINA PRINCIPAL
    const mainPage = document.querySelector('.page');
    const hashTableVisible = document.getElementById('cadenaCustodiaContainer').style.display !== 'none';
    
    if (hashTableVisible) {
      // Procesar paginaci√≥n de hashes si est√° visible
      const paginationResult = await paginateHashTable(PAGE_CONFIG);
      
      // Renderizar p√°gina principal (posiblemente modificada)
      await renderPageToPDF(pdf, mainPage, PAGE_CONFIG, false);
      
      // Renderizar p√°ginas adicionales de hashes
      for (const tempPage of paginationResult.tempPages) {
        await renderPageToPDF(pdf, tempPage, PAGE_CONFIG, true);
        tempPage.remove(); // Limpiar del DOM
      }
      
      // Restaurar tabla original
      paginationResult.restore();
    } else {
      // Sin tabla de hashes, renderizar normalmente
      await renderPageToPDF(pdf, mainPage, PAGE_CONFIG, false);
    }
    
    // 2. PROCESAR IM√ÅGENES (una por p√°gina)
    await addImagesToPDF(pdf, loadedImages, PAGE_CONFIG);
    
    // 3. GUARDAR PDF
    const fileName = generatePDFFileName();
    pdf.save(fileName);
    
    console.log(`PDF generado: ${fileName}`);
    
  } catch (error) {
    console.error('Error al generar PDF:', error);
    alert('Error al generar el PDF. Por favor, intente nuevamente.');
  } finally {
    // Restaurar UI
    restoreDateInput(fechaInput, tempFechaElement);
    showUIElements(uiElements);
    exportPdfBtn.disabled = false;
    exportPdfBtn.textContent = 'üìÑ Exportar a PDF';
    validateForm();
  }
});

// ========== FUNCIONES AUXILIARES ==========

/**
 * Pagina la tabla de hashes en m√∫ltiples p√°ginas si es necesario
 */
async function paginateHashTable(pageConfig) {
  const tableBody = document.getElementById('hashTableBody');
  const rows = Array.from(tableBody.children);
  const mainPage = document.querySelector('.page');
  const tempPages = [];
  
  // Calcular cu√°ntas filas caben en la primera p√°gina
  const mainPageSpace = calculateAvailableSpace(mainPage, pageConfig);
  const rowsPerPage = Math.floor(mainPageSpace / pageConfig.rowHeight);
  
  // Si todas las filas caben, no hacer nada
  if (rows.length <= rowsPerPage) {
    return {
      tempPages: [],
      restore: () => {} // No-op
    };
  }
  
  // Dividir filas entre p√°ginas
  const rowsForMainPage = rows.slice(0, rowsPerPage);
  const overflowRows = rows.slice(rowsPerPage);
  
  // Limpiar tabla principal y dejar solo las que caben
  tableBody.innerHTML = '';
  rowsForMainPage.forEach(row => tableBody.appendChild(row));
  
  // Crear p√°ginas adicionales para las filas desbordadas
  const fullRowsPerExtraPage = Math.floor(
    (pageConfig.maxContentHeight - 20) / pageConfig.rowHeight // -20mm para encabezado
  );
  
  let pageIndex = 1;
  let currentRows = [];
  
  for (let i = 0; i < overflowRows.length; i++) {
    currentRows.push(overflowRows[i]);
    
    // Si llenamos una p√°gina o es la √∫ltima fila
    if (currentRows.length === fullRowsPerExtraPage || i === overflowRows.length - 1) {
      const tempPage = createHashContinuationPage(pageIndex, currentRows);
      document.body.appendChild(tempPage); // Necesario para html2canvas
      tempPage.style.position = 'absolute';
      tempPage.style.left = '-9999px'; // Ocultar visualmente
      tempPages.push(tempPage);
      
      currentRows = [];
      pageIndex++;
    }
  }
  
  // Funci√≥n para restaurar el estado original
  const restore = () => {
    tableBody.innerHTML = '';
    rows.forEach(row => tableBody.appendChild(row));
  };
  
  return { tempPages, restore };
}

/**
 * Calcula el espacio disponible en la p√°gina principal
 */
function calculateAvailableSpace(page, pageConfig) {
  // Estimaci√≥n basada en la estructura conocida
  // Considera encabezado, campos del formulario, firmas, etc.
  const fixedContentHeight = 200; // mm aproximados de contenido fijo
  return pageConfig.maxContentHeight - fixedContentHeight;
}

/**
 * Crea una p√°gina de continuaci√≥n para hashes
 */
function createHashContinuationPage(pageNumber, rows) {
  const page = document.createElement('div');
  page.className = 'page';
  
  page.innerHTML = `
    <div class="page-content">
      <h2 style="text-align: center; margin-bottom: 20px; font-size: 14pt; font-weight: 700;">
        CADENA DE CUSTODIA - CONTINUACI√ìN (P√°gina ${pageNumber + 1})
      </h2>
      <table class="form" style="font-size: 9pt;">
        <thead>
          <tr style="background-color: #f0f0f0;">
            <th style="width: 40%; border: 1px solid #000; padding: 4px;">Nombre del Archivo</th>
            <th style="width: 60%; border: 1px solid #000; padding: 4px;">Hash SHA-256</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="footerNote">Mondelez International Internal ‚Äî Uso exclusivo</div>
    </div>
  `;
  
  const tbody = page.querySelector('tbody');
  rows.forEach(row => tbody.appendChild(row.cloneNode(true)));
  
  return page;
}

/**
 * Renderiza una p√°gina al PDF
 */
async function renderPageToPDF(pdf, element, pageConfig, addNewPage) {
  if (addNewPage) {
    pdf.addPage();
  }
  
  const canvas = await html2canvas(element, {
    scale: 2,
    useCORS: true,
    logging: false,
    backgroundColor: '#ffffff',
    windowWidth: element.scrollWidth,
    windowHeight: element.scrollHeight
  });
  
  const imgData = canvas.toDataURL('image/png');
  const imgHeight = (canvas.height * pageConfig.width) / canvas.width;
  
  pdf.addImage(
    imgData, 
    'PNG', 
    0, 
    0, 
    pageConfig.width, 
    Math.min(imgHeight, pageConfig.height)
  );
}

/**
 * Agrega im√°genes al PDF (una por p√°gina)
 */
async function addImagesToPDF(pdf, images, pageConfig) {
  for (let i = 0; i < images.length; i++) {
    pdf.addPage();
    
    const imageData = images[i];
    const img = new Image();
    img.src = imageData.src;
    
    await new Promise(resolve => {
      img.onload = () => {
        const margin = 15;
        const maxWidth = pageConfig.width - (2 * margin);
        const maxHeight = pageConfig.height - (2 * margin) - 20; // -20 para caption
        
        const scale = Math.min(
          maxWidth / img.width,
          maxHeight / img.height
        );
        
        const finalWidth = img.width * scale;
        const finalHeight = img.height * scale;
        const xPos = (pageConfig.width - finalWidth) / 2;
        const yPos = margin;
        
        // Agregar imagen
        pdf.addImage(imageData.src, 'JPEG', xPos, yPos, finalWidth, finalHeight);
        
        // Agregar caption
        pdf.setFontSize(10);
        pdf.setFont('helvetica', 'normal');
        const captionText = `Imagen ${i + 1}: ${imageData.fileName}`;
        const captionY = yPos + finalHeight + 8;
        pdf.text(captionText, pageConfig.width / 2, captionY, { align: 'center' });
        
        resolve();
      };
    });
  }
}

/**
 * Genera el nombre del archivo PDF
 */
function generatePDFFileName() {
  const casoId = document.getElementById('casoId').value || 'SIN-ID';
  const fecha = document.getElementById('fechaEventos').value || 
                 new Date().toISOString().split('T')[0];
  return `Reporte_CCTV_${casoId}_${fecha}.pdf`;
}

/**
 * Funciones auxiliares de UI
 */
function hideUIElements(elements) {
  Object.values(elements).forEach(el => {
    if (el instanceof NodeList) {
      el.forEach(item => item.style.display = 'none');
    } else if (el) {
      el.style.display = 'none';
    }
  });
}

function showUIElements(elements) {
  Object.values(elements).forEach(el => {
    if (el instanceof NodeList) {
      el.forEach(item => item.style.display = '');
    } else if (el) {
      el.style.display = '';
    }
  });
}

function createTempDateDisplay(formattedDate) {
  const span = document.createElement('span');
  span.textContent = formattedDate;
  span.style.cssText = 'display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; font: inherit;';
  return span;
}

function replaceDateInput(input, replacement) {
  const container = input.parentElement;
  input.style.display = 'none';
  container.appendChild(replacement);
}

function restoreDateInput(input, replacement) {
  input.style.display = '';
  replacement.remove();
}

      // ========== FUNCI√ìN PARA OBTENER DATOS DEL FORMULARIO ==========
      window.getFormData = function() {
        const data = {
          reportadoPor: reportadoPorSelect.value,
          fechaEventos: fechaInput.value,
          tipoReporte: null,
          eventosRegistrados: null,
          sitio: 'PLANTA PACHECO',
          casoId: casoIdInput.value,
          areaEventos: areaEventosInput.value,
          novedades: novedadesTextarea.value,
          imagenes: loadedImages.map((img, index) => ({
            id: img.id,
            fileName: img.fileName,
            timestamp: img.timestamp,
            position: index + 1
          }))
        };

        // Obtener tipo de reporte seleccionado
        const tipoReporteChecked = document.querySelector('input[name="tipoReporte"]:checked');
        if (tipoReporteChecked) {
          data.tipoReporte = tipoReporteChecked.value;
        }

        // Obtener eventos registrados
        const eventosChecked = document.querySelector('input[name="eventosRegistrados"]:checked');
        if (eventosChecked) {
          data.eventosRegistrados = eventosChecked.value;
        }

        return data;
      };

      // Para testing - mostrar datos en consola al cambiar valores
      reportadoPorSelect.addEventListener('change', () => {
        console.log('Datos del formulario:', window.getFormData());
      });

      fechaInput.addEventListener('change', () => {
        console.log('Datos del formulario:', window.getFormData());
      });
      
      casoIdInput.addEventListener('input', () => {
        console.log('Caso ID actualizado:', casoIdInput.value);
      });
      
      areaEventosInput.addEventListener('input', () => {
        console.log('√Årea de eventos actualizada:', areaEventosInput.value);
      });
      
      novedadesTextarea.addEventListener('input', () => {
        console.log('Novedades actualizadas');
      });
    });
  </script>
</body>
</html>
