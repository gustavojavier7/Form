<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reporte CCTV ‚Äì Formato Planilla</title>
  
  <!-- Librer√≠as para exportar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    /* --- Configuraci√≥n general Word-like --- */
    :root{
      --ink:#000;
      --grid:#000;
    }
    body{
      margin:0;
      background:#fff;
      color:var(--ink);
      font-family: Calibri, Arial, sans-serif;
      font-size: 11pt;
    }
    .page{
      width: 210mm;
      min-height: 297mm;
      margin: 10mm auto;
      padding: 0;
      box-sizing: border-box;
      border: 1px solid #000;
    }
    .page-content{
      padding: 12mm;
    }

    /* --- Tabla principal --- */
    table.form{
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    table.form td, table.form th{
      border: 1px solid var(--grid);
      padding: 4px 6px;
      vertical-align: middle;
      line-height: 1.15;
    }

    /* Alturas fijas para consistencia */
    .rH1 td{ height: 78px; }
    
    /* Fila compacta */
    .rowCompact td{ height: 26px; }
    
    /* Encabezado complejo */
    .logoCell{
      text-align: left;
      vertical-align: middle;
    }
    .logoPlaceholder{
      width: 100%;
      height: 40px;
      border: 1px dashed #999;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9pt;
      color: #666;
    }
    .titleCell{
      text-align: center;
      font-weight: 700;
      letter-spacing: 0.5px;
      font-size: 14pt;
    }
    .metaCell{
      text-align: center;
      vertical-align: middle;
    }
    .metaTable{
      width: 100%;
      border-collapse: collapse;
    }
    .metaTable td{
      border: none;
      padding: 1px 4px;
      text-align: left;
      height: auto;
    }
    .metaLabel{
      font-weight: 700;
      width: 40%;
    }
    .metaValue{
      font-weight: 400;
      width: 60%;
    }
    
    /* Labels y valores */
    .rowLabel{
      font-weight: 700;
    }
    .value{
      font-weight: 400;
    }
    
    /* Select field estilo Word */
    .select-field{
      width: 100%;
      border: none;
      background: transparent;
      font: inherit;
      color: inherit;
      padding: 0;
      line-height: 1.15;
      appearance: none;
      -webkit-appearance: none;
      cursor: pointer;
    }
    
    .select-field:focus{
      outline: none;
      background-color: #f0f8ff;
    }
    
    /* Input de texto estilo Word */
    .text-input{
      width: 100%;
      border: none;
      background: transparent;
      font: inherit;
      color: inherit;
      padding: 0;
      line-height: 1.15;
      box-sizing: border-box;
    }
    
    .text-input:focus{
      outline: none;
      background-color: #f0f8ff;
    }
    
    .text-input.invalid{
      border: 2px solid #dc3545;
      padding: 2px;
      background-color: #fff5f5;
    }
    
    /* Select con validaci√≥n */
    .select-field.invalid{
      border: 2px solid #dc3545;
      padding: 2px;
      background-color: #fff5f5;
    }
    
    /* Date input con validaci√≥n */
    .date-input.invalid{
      border: 2px solid #dc3545;
      padding: 2px;
      background-color: #fff5f5;
    }
    
    /* Textarea con validaci√≥n */
    .novedades-textarea.invalid{
      border: 2px solid #dc3545;
      background-color: #fff5f5;
    }
    
    /* Protecci√≥n contra wrap */
    .oneline{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Celda fecha: sin padding extra */
    .dateValueCell{
      text-align: center;
      padding: 0 !important;
    }
    
    /* Contenedor simple: no debe sumar altura */
    .date-input-container{
      width: 100%;
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    /* Input date "Word-like" */
    .date-input{
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      
      border: 0;
      background: transparent;
      font: inherit;
      color: inherit;
      
      text-align: center;
      padding: 0;
      line-height: 26px; /* Altura de la fila compacta para centrado vertical */
      
      appearance: none;
      -webkit-appearance: none;
      
      cursor: pointer;
    }
    
    /* Solo un highlight suave al foco */
    .date-input:focus{
      outline: none;
      background-color: #f0f8ff;
    }
    
    /* Checkboxes - AHORA INTERACTIVOS */
    .cb{
      display:inline-block;
      width: 12px;
      height: 12px;
      border: 1.5px solid #000;
      margin-left: 4px;
      margin-right: 8px;
      vertical-align: middle;
      position: relative;
      cursor: pointer;
      transition: background-color 0.1s ease;
    }
    
    .cb:hover{
      background-color: #f0f0f0;
    }
    
    .cb.checked::after{
      content:"X";
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      font-size: 10px;
      font-weight: bold;
    }
    
    /* Opciones en l√≠nea */
    .opts{
      display: flex;
      gap: 15px;
      flex-wrap: nowrap;
      align-items: center;
    }
    .opts > span{
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }
    .opts-spread{
      justify-content: space-between;
      gap: 0;
    }
    
    /* Secci√≥n Novedades */
    .sectionTitle{
      font-weight: 700;
      background-color: #f0f0f0;
      padding: 6px !important;
    }
    .bigBox{
      vertical-align: top !important;
      padding: 8px !important;
    }
    
    /* Textarea para novedades */
    .novedades-textarea{
      width: 100%;
      min-height: 150px;
      border: 1px solid #ccc;
      padding: 8px;
      font-family: Calibri, Arial, sans-serif;
      font-size: 11pt;
      line-height: 1.5;
      resize: vertical;
      box-sizing: border-box;
      background-color: #fff;
    }
    
    .novedades-textarea:focus{
      outline: none;
      border-color: #0066cc;
      background-color: #f0f8ff;
    }
    
    /* Secci√≥n de carga de im√°genes - Segunda p√°gina */
    .image-upload-area{
      padding: 15px;
    }
    
    .upload-prompt{
      border: 2px dashed #999;
      padding: 20px;
      text-align: center;
      background-color: #f9f9f9;
      margin-bottom: 20px;
    }
    
    #bulkImageUpload{
      padding: 8px;
      font-size: 10pt;
      cursor: pointer;
    }
    
    /* Contenedor de im√°genes cargadas */
    #loadedImagesContainer{
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    
    .loaded-image-item{
      border: 1px solid #ccc;
      padding: 10px;
      background-color: #fff;
      position: relative;
      page-break-inside: avoid;
    }
    
    .loaded-image-item img{
      width: 100%;
      height: auto;
      display: block;
      border: 1px solid #ddd;
    }
    
    .loaded-image-caption{
      margin-top: 8px;
      font-size: 10pt;
      color: #333;
      text-align: center;
      font-weight: 600;
    }
    
    .loaded-image-remove{
      position: absolute;
      top: 15px;
      right: 15px;
      width: 28px;
      height: 28px;
      background-color: rgba(220, 53, 69, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
      z-index: 10;
    }
    
    .loaded-image-remove:hover{
      background-color: rgba(200, 35, 51, 1);
    }
    
    /* Bot√≥n exportar PDF */
    .export-section{
      margin-top: 15px;
      text-align: center;
      padding: 10px 0;
    }
    
    .export-pdf-btn{
      background-color: #0066cc;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 11pt;
      font-family: Calibri, Arial, sans-serif;
      font-weight: 600;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .export-pdf-btn:hover{
      background-color: #0052a3;
    }
    
    .export-pdf-btn:active{
      background-color: #004080;
      transform: translateY(1px);
    }
    
    .export-pdf-btn:disabled{
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    /* Firmas */
    .signatureSection{
      margin-top: 20px;
      border-top: 2px solid #000;
      padding-top: 10px;
    }
    .signatureTable{
      width: 100%;
      border-collapse: collapse;
    }
    .signatureCell{
      padding: 10px;
      vertical-align: top;
      width: 50%;
    }
    .signatureLine{
      border-top: 1px solid #000;
      margin-top: 40px;
      padding-top: 4px;
      font-size: 10pt;
      text-align: center;
    }
    
    /* Pie */
    .footerNote{
      margin-top: 15mm;
      font-size: 9pt;
      text-align: center;
      border-top: 1px solid #ccc;
      padding-top: 5px;
    }
    
    /* Impresi√≥n */
    @media print{
      .page{
        margin: 0;
        border: none;
        page-break-after: always;
      }
      body{
        background:#fff;
      }
      .logoPlaceholder{
        border: 1px solid #ddd;
      }
      .date-input {
        -webkit-appearance: none;
        appearance: none;
      }
      .date-input::-webkit-calendar-picker-indicator {
        display: none;
      }
      .select-field{
        appearance: none;
        -webkit-appearance: none;
      }
      .text-input{
        border: none;
        background: transparent;
      }
      .novedades-textarea{
        border: 1px solid #ccc;
        background: transparent;
      }
      .cb{
        cursor: default;
      }
      .cb:hover{
        background-color: transparent;
      }
      .export-section{
        display: none !important;
      }
      .upload-prompt{
        display: none !important;
      }
      .loaded-image-remove{
        display: none !important;
      }
      #bulkImageUpload, #hashFileInputs{
        display: none !important;
      }
      #calculateHashBtn{
        display: none !important;
      }
      /* Eliminar bordes de validaci√≥n en impresi√≥n */
      .invalid{
        border: none !important;
        background: transparent !important;
      }
      .text-input.invalid,
      .select-field.invalid,
      .date-input.invalid,
      .novedades-textarea.invalid{
        border: none !important;
        background: transparent !important;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="page-content">
      <table class="form" aria-label="Reporte de CCTV">
        <!-- Colgroup para estabilizar columnas -->
        <colgroup>
          <col style="width:20%">
          <col style="width:40%">
          <col style="width:15%">
          <col style="width:25%">
        </colgroup>
        
        <!-- Encabezado -->
        <tr class="rH1">
          <td class="logoCell">
            <img src="logo.png" alt="Logo Mondelez" style="width: 100%; max-height: 70px; object-fit: contain; display: block;">
          </td>
          <td class="titleCell">REPORTE DE CCTV</td>
          <td class="metaCell" colspan="2">
            <table class="metaTable">
              <tr><td class="metaLabel">C√≥digo</td><td class="metaValue">RE PAC PO GS 4.4.6 31-01</td></tr>
              <tr><td class="metaLabel">Fecha del formulario</td><td class="metaValue">19-03-2018</td></tr>
              <tr><td class="metaLabel">Revisi√≥n</td><td class="metaValue">09</td></tr>
            </table>
          </td>
        </tr>

        <!-- Reportado por y Fecha de eventos -->
        <tr class="rowCompact">
          <td class="rowLabel">Reportado por</td>
          <td class="value">
            <select class="select-field" id="reportadoPor">
              <option value="" selected disabled>Choose an item.</option>
              <option>G. L√≥pez</option>
              <option>E. Sosa</option>
              <option>J. Castilla</option>
              <option>J. Mart√≠n</option>
            </select>
          </td>
          <td class="rowLabel" style="text-align:center;">Fecha de eventos</td>
          <td class="dateValueCell">
            <div class="date-input-container">
              <input type="date" id="fechaEventos" class="date-input" value="">
            </div>
          </td>
        </tr>

        <!-- Tipo de Reporte - CHECKBOXES INTERACTIVOS -->
        <tr>
          <td class="rowLabel">Tipo de Reporte</td>
          <td class="value" colspan="3">
            <div class="opts opts-spread">
              <span data-checkbox-group="tipoReporte" data-checkbox-value="caso">
                Caso <span class="cb" data-checkbox="tipoReporte-caso"></span>
              </span>
              <span data-checkbox-group="tipoReporte" data-checkbox-value="monitoreo">
                Monitoreo <span class="cb" data-checkbox="tipoReporte-monitoreo"></span>
              </span>
              <span data-checkbox-group="tipoReporte" data-checkbox-value="novedades">
                Novedades <span class="cb checked" data-checkbox="tipoReporte-novedades"></span>
              </span>
              <span data-checkbox-group="tipoReporte" data-checkbox-value="investigacion">
                Investigaci√≥n <span class="cb" data-checkbox="tipoReporte-investigacion"></span>
              </span>
              <span data-checkbox-group="tipoReporte" data-checkbox-value="auditoria">
                Auditor√≠a <span class="cb" data-checkbox="tipoReporte-auditoria"></span>
              </span>
            </div>
          </td>
        </tr>

        <!-- Sitio / Caso ID -->
        <tr>
          <td class="rowLabel">Sitio</td>
          <td class="value oneline">PLANTA PACHECO</td>
          <td class="rowLabel" style="text-align:center;">Reporte ID</td>
          <td class="value oneline">
            <input type="text" id="casoId" class="text-input" value="" maxlength="19" placeholder="[Auto-generado]">
          </td>
        </tr>

        <!-- Eventos registrados / √Årea - CHECKBOXES INTERACTIVOS -->
        <tr>
          <td class="rowLabel">1.- ¬øPreservar evidencia?</td>
          <td class="value">
            <div class="opts">
              <span data-checkbox-group="eventosRegistrados" data-checkbox-value="si">
                S√≠ <span class="cb" data-checkbox="eventosRegistrados-si"></span>
              </span>
              <span data-checkbox-group="eventosRegistrados" data-checkbox-value="no">
                No <span class="cb checked" data-checkbox="eventosRegistrados-no"></span>
              </span>
            </div>
          </td>
          <td class="rowLabel">2.- √Årea de los eventos:</td>
          <td class="value oneline">
            <input type="text" id="areaEventos" class="text-input" value="" maxlength="50" placeholder="[Escribir √Årea]">
          </td>
        </tr>

        <!-- Novedades -->
        <tr>
          <td class="sectionTitle" colspan="4">4.- Novedades:</td>
        </tr>
        <tr>
          <td class="bigBox" colspan="4">
            <textarea id="novedadesText" class="novedades-textarea" rows="10" placeholder="[Escriba Novedades]"></textarea>
          </td>
        </tr>
      </table>

      <!-- Secci√≥n de firmas -->
      <div class="signatureSection">
        <table class="signatureTable">
          <tr>
            <td class="signatureCell">
              <div class="signatureLine">
                Reporte generado por<br>
                <span id="reporteGeneradoPor">Choose an item.</span>
              </div>
            </td>
            <td class="signatureCell">
              <div class="signatureLine">
                Reporte revisado por<br>
                G. LOPEZ
              </div>
            </td>
          </tr>
        </table>
      </div>

      <!-- Secci√≥n de Preservaci√≥n de Evidencia (condicional) -->
      <div id="preservacionSection" style="border-top: 2px solid #000; margin-top: 20px; padding-top: 20px; display: none;">
        <h3 style="font-size: 12pt; font-weight: 700;">PRESERVACI√ìN DE LA EVIDENCIA</h3>
        <div class="upload-prompt">
          <p style="font-weight: 700; margin-bottom: 10px;">Cargar archivos para Cadena de Custodia (Video/Fotos):</p>
          <input type="file" id="hashFileInputs" multiple style="margin-bottom: 10px;">
          <br>
          <button id="calculateHashBtn" class="export-pdf-btn" style="background-color: #28a745; margin-top: 10px;">üîí Calcular Hash SHA-256</button>
          <p style="font-size: 9pt; color: #666; margin-top: 8px;">*Calcula el hash SHA-256 de todos los archivos de fotograf√≠a y video</p>
        </div>
        
        <div id="cadenaCustodiaContainer" style="margin-top: 20px; display: none;">
          <h3 style="font-size: 11pt; font-weight: 700; border-bottom: 1px solid #000; padding-bottom: 5px;">CADENA DE CUSTODIA (HASH SHA-256)</h3>
          <table class="form" id="hashTable" style="font-size: 9pt; margin-top: 10px;">
            <thead>
              <tr style="background-color: #f0f0f0;">
                <th style="width: 40%;">Nombre del Archivo</th>
                <th style="width: 60%;">Hash SHA-256</th>
              </tr>
            </thead>
            <tbody id="hashTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="footerNote">Mondelez International Internal ‚Äî Uso exclusivo</div>
    </div>
  </div>

  <!-- SEGUNDA P√ÅGINA: Im√°genes CCTV -->
  <div class="page" id="imagesPage">
    <div class="page-content">
      <h2 style="text-align: center; margin-bottom: 20px; font-size: 14pt; font-weight: 700;">EVIDENCIA FOTOGR√ÅFICA - IM√ÅGENES CCTV</h2>
      
      <!-- √Årea para cargar im√°genes -->
      <div class="image-upload-area">
        <div class="upload-prompt">
          <p style="font-weight: 700; margin-bottom: 10px;">Cargar im√°genes de evidencia CCTV:</p>
          <input type="file" id="bulkImageUpload" accept="image/png, image/jpeg, image/jpg" multiple style="margin-bottom: 15px;">
          <p style="font-size: 9pt; color: #666; margin-top: 5px;">Formatos permitidos: PNG, JPG. Puede seleccionar m√∫ltiples archivos.</p>
        </div>
        
        <!-- Contenedor donde se mostrar√°n las im√°genes cargadas -->
        <div id="loadedImagesContainer"></div>
      </div>

      <!-- Bot√≥n de exportar a PDF -->
      <div class="export-section">
        <button id="exportPdfBtn" class="export-pdf-btn">üìÑ Exportar a PDF</button>
      </div>

      <div class="footerNote">Mondelez International Internal ‚Äî Uso exclusivo</div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ========== DECLARACI√ìN DE VARIABLES ==========
      const fechaInput = document.getElementById('fechaEventos');
      const reportadoPorSelect = document.getElementById('reportadoPor');
      const reporteGeneradoPorSpan = document.getElementById('reporteGeneradoPor');
      const exportPdfBtn = document.getElementById('exportPdfBtn');
      const casoIdInput = document.getElementById('casoId');
      const areaEventosInput = document.getElementById('areaEventos');
      const novedadesTextarea = document.getElementById('novedadesText');
      const bulkImageUpload = document.getElementById('bulkImageUpload');
      const loadedImagesContainer = document.getElementById('loadedImagesContainer');
      const preservacionSection = document.getElementById('preservacionSection');
      const calculateHashBtn = document.getElementById('calculateHashBtn');
      const hashFileInputs = document.getElementById('hashFileInputs');
      const hashTableBody = document.getElementById('hashTableBody');
      const cadenaCustodiaContainer = document.getElementById('cadenaCustodiaContainer');
      
      let loadedImages = []; // Array para almacenar las im√°genes cargadas

      // ========== FUNCI√ìN PARA FORMATEAR FECHA ==========
      function formatearFechaDisplay(fechaISO) {
        if (!fechaISO) return '';
        const partes = fechaISO.split('-');
        return `${partes[2]}-${partes[1]}-${partes[0]}`; // DD-MM-YYYY
      }

      // Configurar t√≠tulo del input de fecha
      fechaInput.title = 'Haz clic para seleccionar una fecha';

      // ========== SINCRONIZACI√ìN REPORTADO POR ==========
      
      // Sincronizar cuando cambia la selecci√≥n
      reportadoPorSelect.addEventListener('change', () => {
        const selectedValue = reportadoPorSelect.value;
        reporteGeneradoPorSpan.textContent = selectedValue || 'Choose an item.';
        console.log('Reportado por actualizado:', selectedValue);
        validateForm(); // Validar al cambiar
      });

      // ========== GENERACI√ìN AUTOM√ÅTICA DE REPORTE ID ==========
      
      function generateReporteId() {
        // Obtener timestamp Unix en milisegundos
        const timestampMs = Date.now();
        
        // Convertir a string y asegurar 16 d√≠gitos
        let timestampStr = timestampMs.toString();
        
        // Si tiene menos de 16 d√≠gitos, rellenar con el timestamp en microsegundos (simulado)
        if (timestampStr.length < 16) {
          // Agregar d√≠gitos adicionales basados en performance.now() para mayor precisi√≥n
          const microPrecision = Math.floor((performance.now() % 1) * 1000000).toString().padStart(6, '0');
          timestampStr = timestampStr + microPrecision.substring(0, 16 - timestampStr.length);
        }
        
        // Tomar exactamente 16 d√≠gitos
        timestampStr = timestampStr.substring(0, 16);
        
        // Formatear como 0000-0000-0000-0000
        const reporteId = timestampStr.match(/.{1,4}/g).join('-');
        
        return reporteId;
      }
      
      // Generar Reporte ID autom√°ticamente al cargar la p√°gina
      if (!casoIdInput.value || casoIdInput.value.trim() === '') {
        const nuevoReporteId = generateReporteId();
        casoIdInput.value = nuevoReporteId;
        console.log('Reporte ID generado autom√°ticamente:', nuevoReporteId);
        validateForm(); // Validar despu√©s de generar
      }
      
      // Bot√≥n para regenerar Reporte ID manualmente
      const regenerarIdBtn = document.createElement('button');
      regenerarIdBtn.textContent = 'üîÑ';
      regenerarIdBtn.title = 'Generar nuevo Reporte ID';
      regenerarIdBtn.className = 'export-pdf-btn';
      regenerarIdBtn.style.cssText = 'background-color: #6c757d; padding: 4px 8px; font-size: 9pt; margin-left: 5px; display: inline-block; vertical-align: middle;';
      regenerarIdBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const nuevoReporteId = generateReporteId();
        casoIdInput.value = nuevoReporteId;
        console.log('Reporte ID regenerado:', nuevoReporteId);
        validateForm();
      });
      
      // Insertar el bot√≥n junto al input
      casoIdInput.parentElement.appendChild(regenerarIdBtn);

      // ========== VALIDACI√ìN DEL FORMULARIO ==========
      
      function validateForm() {
        const fechaValida = fechaInput.value && fechaInput.value.trim() !== '';
        const reportadoPorValido = reportadoPorSelect.value && reportadoPorSelect.value.trim() !== '';
        const casoIdValido = casoIdInput.value && casoIdInput.value.trim() !== '';
        const areaEventosValida = areaEventosInput.value && areaEventosInput.value.trim() !== '';
        const novedadesValidas = novedadesTextarea.value && novedadesTextarea.value.trim() !== '';
        
        // Actualizar clases de validaci√≥n visual
        if (fechaValida) {
          fechaInput.classList.remove('invalid');
        } else {
          fechaInput.classList.add('invalid');
        }
        
        if (reportadoPorValido) {
          reportadoPorSelect.classList.remove('invalid');
        } else {
          reportadoPorSelect.classList.add('invalid');
        }
        
        if (casoIdValido) {
          casoIdInput.classList.remove('invalid');
        } else {
          casoIdInput.classList.add('invalid');
        }
        
        if (areaEventosValida) {
          areaEventosInput.classList.remove('invalid');
        } else {
          areaEventosInput.classList.add('invalid');
        }
        
        if (novedadesValidas) {
          novedadesTextarea.classList.remove('invalid');
        } else {
          novedadesTextarea.classList.add('invalid');
        }
        
        // Validaci√≥n para Cadena de Custodia
        const siPreservarChecked = document.querySelector('[data-checkbox-group="eventosRegistrados"] .cb.checked')?.parentElement.dataset.checkboxValue === 'si';
        const hashesCalculados = document.getElementById('hashTableBody').children.length > 0;
        const preservacionValida = !siPreservarChecked || (siPreservarChecked && hashesCalculados);

        const formularioValido = fechaValida && reportadoPorValido && casoIdValido && areaEventosValida && novedadesValidas && preservacionValida;
        
        if (formularioValido) {
          exportPdfBtn.disabled = false;
          exportPdfBtn.style.backgroundColor = '#0066cc';
          exportPdfBtn.style.cursor = 'pointer';
        } else {
          exportPdfBtn.disabled = true;
          exportPdfBtn.style.backgroundColor = '#cccccc';
          exportPdfBtn.style.cursor = 'not-allowed';
        }
        
        return formularioValido;
      }
      
      // Validar cuando cambia la fecha
      fechaInput.addEventListener('change', validateForm);
      fechaInput.addEventListener('input', validateForm);
      fechaInput.addEventListener('focus', () => {
        fechaInput.classList.remove('invalid');
      });
      fechaInput.addEventListener('blur', validateForm);
      
      // Validar cuando cambia el Caso ID
      casoIdInput.addEventListener('input', validateForm);
      casoIdInput.addEventListener('change', validateForm);
      casoIdInput.addEventListener('focus', () => {
        casoIdInput.classList.remove('invalid');
      });
      casoIdInput.addEventListener('blur', validateForm);
      
      // Validar cuando cambia el √Årea de eventos
      areaEventosInput.addEventListener('input', validateForm);
      areaEventosInput.addEventListener('change', validateForm);
      areaEventosInput.addEventListener('focus', () => {
        areaEventosInput.classList.remove('invalid');
      });
      areaEventosInput.addEventListener('blur', validateForm);
      
      // Validar cuando cambia Novedades
      novedadesTextarea.addEventListener('input', validateForm);
      novedadesTextarea.addEventListener('change', validateForm);
      novedadesTextarea.addEventListener('focus', () => {
        novedadesTextarea.classList.remove('invalid');
      });
      novedadesTextarea.addEventListener('blur', validateForm);
      
      // Validar cuando cambia Reportado por
      reportadoPorSelect.addEventListener('focus', () => {
        reportadoPorSelect.classList.remove('invalid');
      });
      reportadoPorSelect.addEventListener('blur', validateForm);
      
      // Validaci√≥n inicial al cargar la p√°gina
      validateForm();

      // ========== MANEJO DE IM√ÅGENES - CARGA M√öLTIPLE ==========

      bulkImageUpload.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        
        files.forEach(file => {
          if (file && (file.type === 'image/png' || file.type === 'image/jpeg' || file.type === 'image/jpg')) {
            const reader = new FileReader();
            
            reader.onload = (event) => {
              const imageData = {
                id: Date.now() + Math.random(), // ID √∫nico
                src: event.target.result,
                fileName: file.name,
                timestamp: new Date().toLocaleString('es-AR')
              };
              
              loadedImages.push(imageData);
              renderImages();
              console.log(`Imagen cargada: ${file.name}`);
            };
            
            reader.readAsDataURL(file);
          } else {
            alert(`El archivo ${file.name} no es una imagen PNG o JPG v√°lida`);
          }
        });
        
        // Resetear el input para permitir cargar las mismas im√°genes nuevamente si es necesario
        bulkImageUpload.value = '';
      });

      // Funci√≥n para renderizar todas las im√°genes
      function renderImages() {
        loadedImagesContainer.innerHTML = '';
        
        loadedImages.forEach((imageData, index) => {
          const imageItem = document.createElement('div');
          imageItem.className = 'loaded-image-item';
          imageItem.dataset.imageId = imageData.id;
          
          imageItem.innerHTML = `
            <button class="loaded-image-remove" data-image-id="${imageData.id}" title="Eliminar imagen">√ó</button>
            <img src="${imageData.src}" alt="${imageData.fileName}">
            <div class="loaded-image-caption">
              Imagen ${index + 1}: ${imageData.fileName}
            </div>
          `;
          
          loadedImagesContainer.appendChild(imageItem);
        });
        
        // Agregar event listeners a los botones de eliminar
        document.querySelectorAll('.loaded-image-remove').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const imageId = parseFloat(e.target.dataset.imageId);
            loadedImages = loadedImages.filter(img => img.id !== imageId);
            renderImages();
            console.log('Imagen eliminada');
          });
        });
      }

      // ========== CHECKBOXES INTERACTIVOS ==========
      // Funci√≥n para manejar checkboxes con exclusi√≥n mutua
      function setupCheckboxGroup(groupName) {
        const groupItems = document.querySelectorAll(`[data-checkbox-group="${groupName}"]`);
        
        groupItems.forEach(item => {
          const checkbox = item.querySelector('.cb');
          const value = item.dataset.checkboxValue;
          
          // Hacer clickeable tanto el span como el checkbox
          item.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Desmarcar todos los checkboxes del grupo
            groupItems.forEach(otherItem => {
              otherItem.querySelector('.cb').classList.remove('checked');
            });
            
            // Marcar el checkbox clickeado
            checkbox.classList.add('checked');
            
            // Log para debugging (opcional)
            console.log(`${groupName}: ${value} seleccionado`);
          });
        });
      }

      // Inicializar grupos de checkboxes
      setupCheckboxGroup('tipoReporte');
      setupCheckboxGroup('eventosRegistrados');

      // Control de visibilidad para la secci√≥n de preservaci√≥n
      const opcionesEventos = document.querySelectorAll('[data-checkbox-group="eventosRegistrados"]');
      
      opcionesEventos.forEach(opcion => {
        opcion.addEventListener('click', () => {
          const valor = opcion.dataset.checkboxValue;
          if (valor === 'si') {
            preservacionSection.style.display = 'block';
            validateForm(); // Revalidar al marcar "s√≠" para deshabilitar el bot√≥n
          } else {
            preservacionSection.style.display = 'none';
            validateForm(); // Revalida al marcar "no"
            // Opcional: limpiar la tabla de hashes si se marca "no"
            document.getElementById('hashTableBody').innerHTML = '';
            document.getElementById('cadenaCustodiaContainer').style.display = 'none';
          }
        });
      });

      // ========== C√ÅLCULO DE HASH SHA-256 ==========

      async function computeSHA256(file) {
        const buffer = await file.arrayBuffer();
        const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      }

      calculateHashBtn.addEventListener('click', async () => {
        const files = Array.from(hashFileInputs.files);
        if (files.length === 0) {
          alert('Por favor, selecciona archivos primero.');
          return;
        }

        calculateHashBtn.disabled = true;
        calculateHashBtn.textContent = '‚åõ Calculando...';
        hashTableBody.innerHTML = '';
        cadenaCustodiaContainer.style.display = 'block';

        for (const file of files) {
          const hash = await computeSHA256(file);
          const row = `<tr>
            <td style="word-break: break-all;">${file.name}</td>
            <td style="font-family: monospace; word-break: break-all;">${hash}</td>
          </tr>`;
          hashTableBody.insertAdjacentHTML('beforeend', row);
        }

        calculateHashBtn.disabled = false;
        calculateHashBtn.textContent = 'üîí Calcular Hash SHA-256';
        validateForm(); // Revalida para habilitar el bot√≥n de exportaci√≥n
        alert('C√°lculo de hashes completado e insertado en el reporte.');
      });

      // ========== EXPORTAR A PDF ==========
     // ========== EXPORTAR A PDF CON PAGINACI√ìN INTELIGENTE ==========
      exportPdfBtn.addEventListener('click', async () => {
        // 1. Validar antes de exportar
        if (!validateForm()) {
          alert('Por favor, complete los campos obligatorios y aseg√∫rese de calcular los hashes si corresponde.');
          return;
        }
        
        // Bloquear UI
        exportPdfBtn.disabled = true;
        exportPdfBtn.textContent = '‚è≥ Paginando y Generando PDF...';

        // Elementos a ocultar para la "foto"
        const exportSection = document.querySelector('.export-section');
        const removeButtons = document.querySelectorAll('.loaded-image-remove');
        const uploadPrompts = document.querySelectorAll('.upload-prompt');
        const hashBtn = document.getElementById('calculateHashBtn');
        const hashInput = document.getElementById('hashFileInputs');
        const bulkInput = document.getElementById('bulkImageUpload');
        
        // Ocultar elementos de control
        exportSection.style.display = 'none';
        removeButtons.forEach(btn => btn.style.display = 'none');
        uploadPrompts.forEach(el => el.style.display = 'none');
        hashBtn.style.display = 'none';
        hashInput.style.display = 'none';
        bulkInput.style.display = 'none';

        // --- PREPARACI√ìN DE FECHA ---
        const fechaOriginal = fechaInput.value;
        const fechaFormateada = formatearFechaDisplay(fechaOriginal);
        const tempFechaSpan = document.createElement('span');
        tempFechaSpan.textContent = fechaFormateada;
        tempFechaSpan.style.cssText = 'display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; font: inherit;';
        const dateContainer = fechaInput.parentElement;
        fechaInput.style.display = 'none';
        dateContainer.appendChild(tempFechaSpan);

        try {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
          
          const pageWidth = 210; 
          const pageHeight = 297; 

          // Referencia a la p√°gina principal y la tabla
          const page1 = document.querySelector('.page'); // La primera p√°gina
          const tableBody = document.getElementById('hashTableBody');
          const rows = Array.from(tableBody.children); // Copia de las filas
          
          // Array para guardar las p√°ginas TEMPORALES generadas
          let tempPages = [];

          // --- L√ìGICA DE PAGINACI√ìN DE HASHES ---
          // Si hay filas de hash, verificar si desbordan
          if (rows.length > 0) {
            // Altura m√°xima segura en p√≠xeles (aprox 297mm menos m√°rgenes a 96dpi ~ 1122px)
            // Usamos scrollHeight para ver el contenido real
            const MAX_HEIGHT_PX = 1090; // Un poco menos de 1123px para margen de seguridad
            
            // Si la p√°gina 1 excede la altura, empezamos a mover filas
            if (page1.scrollHeight > MAX_HEIGHT_PX) {
              
              // Crear contenedor para la p√°gina 2 (y subsiguientes)
              let currentPageIndex = 1;
              let currentTempPage = createTempPage(currentPageIndex);
              document.body.appendChild(currentTempPage); // Agregar al DOM para que tenga dimensiones
              tempPages.push(currentTempPage);
              
              let currentTableBody = currentTempPage.querySelector('tbody');

              // Iterar desde la √∫ltima fila hacia arriba para encontrar el punto de corte
              // O mejor: Sacar filas de la tabla original hasta que la Pag 1 entre en altura
              
              // Mover todas las filas a un array en memoria y reconstruir
              // Es m√°s seguro vaciar la tabla y llenarla hasta que se llene
              rows.forEach(row => row.remove()); // Sacar todas las filas del DOM visualmente

              let page1Full = false;

              for (let row of rows) {
                if (!page1Full) {
                  tableBody.appendChild(row);
                  // Verificamos si al agregar esta fila nos pasamos
                  if (page1.scrollHeight > MAX_HEIGHT_PX) {
                    // Si nos pasamos, esta fila DEBE ir a la siguiente p√°gina
                    row.remove(); 
                    page1Full = true;
                    
                    // Agregar a la p√°gina temporal actual
                    currentTableBody.appendChild(row);
                  }
                } else {
                  // La p√°gina 1 ya est√° llena, agregar a la p√°gina temporal actual
                  currentTableBody.appendChild(row);
                  
                  // Verificar si la p√°gina temporal se llen√≥
                  if (currentTempPage.scrollHeight > MAX_HEIGHT_PX) {
                    // La fila actual hizo desbordar la Pag 2, moverla a una Pag 3
                    row.remove();
                    
                    // Crear Pag 3
                    currentPageIndex++;
                    currentTempPage = createTempPage(currentPageIndex);
                    document.body.appendChild(currentTempPage);
                    tempPages.push(currentTempPage);
                    currentTableBody = currentTempPage.querySelector('tbody');
                    
                    currentTableBody.appendChild(row);
                  }
                }
              }
            }
          }

          // --- RENDERIZADO DE P√ÅGINAS ---
          
          // 1. Renderizar P√°gina 1 (Main Form)
          await addPageToPdf(pdf, page1, pageWidth, pageHeight, false);

          // 2. Renderizar P√°ginas Temporales de Hashes (si existen)
          for (let tempPage of tempPages) {
            await addPageToPdf(pdf, tempPage, pageWidth, pageHeight, true);
          }

          // 3. Renderizar Im√°genes (Images Page)
          // Nota: Usamos la l√≥gica anterior de imagen por p√°gina para mantener calidad
          if (loadedImages.length > 0) {
             for (let i = 0; i < loadedImages.length; i++) {
              const imageData = loadedImages[i];
              pdf.addPage(); // Nueva hoja en el PDF
              
              const img = new Image();
              img.src = imageData.src;
              await new Promise(r => img.onload = r); // Esperar carga

              // Calcular dimensiones "fit"
              const margin = 10;
              const maxWidth = pageWidth - (2 * margin);
              const maxHeight = pageHeight - (2 * margin);
              const ratio = Math.min(maxWidth / img.width, maxHeight / img.height);
              const finalW = img.width * ratio;
              const finalH = img.height * ratio;
              const xPos = (pageWidth - finalW) / 2;
              const yPos = margin;

              pdf.addImage(imageData.src, 'JPEG', xPos, yPos, finalW, finalH);
              
              // Caption
              pdf.setFontSize(10);
              const captionText = `Imagen ${i + 1}: ${imageData.fileName}`;
              pdf.text(captionText, pageWidth / 2, yPos + finalH + 5, { align: 'center' });
            }
          }

          // --- GUARDAR PDF ---
          const casoId = casoIdInput.value || 'CCTV';
          const fecha = fechaInput.value || 'Fecha';
          pdf.save(`Reporte_CCTV_${casoId}_${fecha}.pdf`);

          // --- RESTAURACI√ìN (LIMPIEZA) ---
          // 1. Eliminar p√°ginas temporales del DOM
          tempPages.forEach(p => p.remove());
          
          // 2. Devolver todas las filas a la tabla original (Page 1)
          rows.forEach(row => tableBody.appendChild(row));
          
        } catch (error) {
          console.error('Error generando PDF:', error);
          alert('Error al generar PDF. Revise la consola.');
        } finally {
          // Restaurar UI
          fechaInput.style.display = '';
          tempFechaSpan.remove();
          exportSection.style.display = 'block';
          removeButtons.forEach(btn => btn.style.display = '');
          uploadPrompts.forEach(el => el.style.display = '');
          hashBtn.style.display = '';
          hashInput.style.display = '';
          bulkInput.style.display = '';
          exportPdfBtn.disabled = false;
          exportPdfBtn.textContent = 'üìÑ Exportar a PDF';
          validateForm();
        }
      });

      // --- FUNCIONES AUXILIARES PARA EL PDF ---
      
      // Funci√≥n para clonar la estructura base para una p√°gina de continuaci√≥n
      function createTempPage(index) {
        const div = document.createElement('div');
        div.className = 'page';
        div.style.position = 'absolute'; // Fuera de flujo visual normal
        div.style.top = '-9999px';
        div.style.left = '0';
        
        // Estructura interna simplificada
        div.innerHTML = `
          <div class="page-content">
            <h3 style="text-align:center; font-size:12pt; font-weight:700; margin-bottom:10px;">
              ANEXO CADENA DE CUSTODIA (Continuaci√≥n ${index})
            </h3>
            <table class="form" style="font-size: 9pt;">
              <thead>
                <tr style="background-color: #f0f0f0;">
                  <th style="width: 40%;">Nombre del Archivo</th>
                  <th style="width: 60%;">Hash SHA-256</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="footerNote" style="margin-top:20px;">Mondelez International Internal ‚Äî Uso exclusivo</div>
          </div>
        `;
        return div;
      }

      // Funci√≥n as√≠ncrona para renderizar un elemento DOM a una p√°gina PDF
      async function addPageToPdf(pdf, element, pWidth, pHeight, addNewPage) {
        if (addNewPage) pdf.addPage();
        
        const canvas = await html2canvas(element, {
          scale: 2,
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff'
        });
        
        const imgHeight = (canvas.height * pWidth) / canvas.width;
        // Si la imagen generada es menor que A4, usar su altura, si no, ajustar a A4
        const renderHeight = imgHeight > pHeight ? pHeight : imgHeight;
        
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, pWidth, renderHeight);
      }

      // ========== FUNCI√ìN PARA OBTENER DATOS DEL FORMULARIO ==========
      window.getFormData = function() {
        const data = {
          reportadoPor: reportadoPorSelect.value,
          fechaEventos: fechaInput.value,
          tipoReporte: null,
          eventosRegistrados: null,
          sitio: 'PLANTA PACHECO',
          casoId: casoIdInput.value,
          areaEventos: areaEventosInput.value,
          novedades: novedadesTextarea.value,
          imagenes: loadedImages.map((img, index) => ({
            id: img.id,
            fileName: img.fileName,
            timestamp: img.timestamp,
            position: index + 1
          }))
        };

        // Obtener tipo de reporte seleccionado
        const tipoReporteChecked = document.querySelector('[data-checkbox-group="tipoReporte"] .cb.checked');
        if (tipoReporteChecked) {
          data.tipoReporte = tipoReporteChecked.parentElement.dataset.checkboxValue;
        }

        // Obtener eventos registrados
        const eventosChecked = document.querySelector('[data-checkbox-group="eventosRegistrados"] .cb.checked');
        if (eventosChecked) {
          data.eventosRegistrados = eventosChecked.parentElement.dataset.checkboxValue;
        }

        return data;
      };

      // Para testing - mostrar datos en consola al cambiar valores
      reportadoPorSelect.addEventListener('change', () => {
        console.log('Datos del formulario:', window.getFormData());
      });

      fechaInput.addEventListener('change', () => {
        console.log('Datos del formulario:', window.getFormData());
      });
      
      casoIdInput.addEventListener('input', () => {
        console.log('Caso ID actualizado:', casoIdInput.value);
      });
      
      areaEventosInput.addEventListener('input', () => {
        console.log('√Årea de eventos actualizada:', areaEventosInput.value);
      });
      
      novedadesTextarea.addEventListener('input', () => {
        console.log('Novedades actualizadas');
      });
    });
  </script>
</body>
</html>
