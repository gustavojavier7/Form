<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reporte CCTV ‚Äì Formato Planilla</title>
  
  <!-- Librer√≠as para exportar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    /* --- Configuraci√≥n general Word-like --- */
    :root{
      --ink:#000;
      --grid:#000;
    }
    body{
      margin:0;
      background:#fff;
      color:var(--ink);
      font-family: Calibri, Arial, sans-serif;
      font-size: 11pt;
    }
    .page{
      width: 210mm;
      min-height: 297mm;
      margin: 10mm auto;
      padding: 0;
      box-sizing: border-box;
      border: 1px solid #000;
    }
    .page-content{
      padding: 12mm;
    }

    /* --- Tabla principal --- */
    table.form{
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    table.form td, table.form th{
      border: 1px solid var(--grid);
      padding: 4px 6px;
      vertical-align: middle;
      line-height: 1.15;
    }

    /* Alturas fijas para consistencia */
    .rH1 td{ height: 78px; }
    
    /* Fila compacta */
    .rowCompact td{ height: 26px; }
    
    /* Encabezado complejo */
    .logoCell{
      text-align: left;
      vertical-align: middle;
    }
    .logoPlaceholder{
      width: 100%;
      height: 40px;
      border: 1px dashed #999;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9pt;
      color: #666;
    }
    .titleCell{
      text-align: center;
      font-weight: 700;
      letter-spacing: 0.5px;
      font-size: 14pt;
    }
    .metaCell{
      text-align: center;
      vertical-align: middle;
    }
    .metaTable{
      width: 100%;
      border-collapse: collapse;
    }
    .metaTable td{
      border: none;
      padding: 1px 4px;
      text-align: left;
      height: auto;
    }
    .metaLabel{
      font-weight: 700;
      width: 40%;
    }
    .metaValue{
      font-weight: 400;
      width: 60%;
    }
    
    /* Labels y valores */
    .rowLabel{
      font-weight: 700;
    }
    .value{
      font-weight: 400;
    }
    
    /* Select field estilo Word */
    .select-field{
      width: 100%;
      border: none;
      background: transparent;
      font: inherit;
      color: inherit;
      padding: 0;
      line-height: 1.15;
      appearance: none;
      -webkit-appearance: none;
      cursor: pointer;
    }
    
    .select-field:focus{
      outline: none;
      background-color: #f0f8ff;
    }
    
    /* Input de texto estilo Word */
    .text-input{
      width: 100%;
      border: none;
      background: transparent;
      font: inherit;
      color: inherit;
      padding: 0;
      line-height: 1.15;
      box-sizing: border-box;
    }
    
    .text-input:focus{
      outline: none;
      background-color: #f0f8ff;
    }
    
    /* Protecci√≥n contra wrap */
    .oneline{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Celda fecha: sin padding extra */
    .dateValueCell{
      text-align: center;
      padding: 0 !important;
    }
    
    /* Contenedor simple: no debe sumar altura */
    .date-input-container{
      width: 100%;
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    /* Input date "Word-like" */
    .date-input{
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      
      border: 0;
      background: transparent;
      font: inherit;
      color: inherit;
      
      text-align: center;
      padding: 0;
      line-height: 1.15;
      
      appearance: none;
      -webkit-appearance: none;
      
      cursor: pointer;
    }
    
    /* Solo un highlight suave al foco */
    .date-input:focus{
      outline: none;
      background-color: #f0f8ff;
    }
    
    /* Checkboxes - AHORA INTERACTIVOS */
    .cb{
      display:inline-block;
      width: 12px;
      height: 12px;
      border: 1.5px solid #000;
      margin-left: 4px;
      margin-right: 8px;
      vertical-align: middle;
      position: relative;
      cursor: pointer;
      transition: background-color 0.1s ease;
    }
    
    .cb:hover{
      background-color: #f0f0f0;
    }
    
    .cb.checked::after{
      content:"X";
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      font-size: 10px;
      font-weight: bold;
    }
    
    /* Opciones en l√≠nea */
    .opts{
      display: flex;
      gap: 15px;
      flex-wrap: nowrap;
      align-items: center;
    }
    .opts > span{
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }
    .opts-spread{
      justify-content: space-between;
      gap: 0;
    }
    
    /* Secci√≥n Novedades */
    .sectionTitle{
      font-weight: 700;
      background-color: #f0f0f0;
      padding: 6px !important;
    }
    .bigBox{
      vertical-align: top !important;
      padding: 8px !important;
    }
    .bigBox ul{
      margin: 4px 0 0 20px;
      padding:0;
    }
    .bigBox li{
      margin: 6px 0;
    }
    
    /* Grid de im√°genes */
    .imageGrid{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .imageCell{
      text-align: center;
      padding: 8px;
      width: 33.33%;
      vertical-align: top;
    }
    .imagePlaceholder{
      width: 100%;
      height: 120px;
      border: 1px solid #ccc;
      background: #f9f9f9;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10pt;
      color: #777;
      margin-bottom: 8px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: background-color 0.2s ease;
    }
    
    .imagePlaceholder:hover{
      background-color: #f0f0f0;
      border-color: #999;
    }
    
    .imagePlaceholder.has-image{
      background: transparent;
      padding: 0;
    }
    
    .imagePlaceholder img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    .imagePlaceholder .placeholder-text{
      pointer-events: none;
    }
    
    .imagePlaceholder input[type="file"]{
      display: none;
    }
    
    /* Bot√≥n para eliminar imagen */
    .remove-image-btn{
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      background-color: rgba(220, 53, 69, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      line-height: 1;
      display: none;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
      z-index: 10;
    }
    
    .remove-image-btn:hover{
      background-color: rgba(200, 35, 51, 1);
    }
    
    .imagePlaceholder.has-image .remove-image-btn{
      display: flex;
    }
    
    /* Bot√≥n exportar PDF */
    .export-section{
      margin-top: 15px;
      text-align: center;
      padding: 10px 0;
    }
    
    .export-pdf-btn{
      background-color: #0066cc;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 11pt;
      font-family: Calibri, Arial, sans-serif;
      font-weight: 600;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .export-pdf-btn:hover{
      background-color: #0052a3;
    }
    
    .export-pdf-btn:active{
      background-color: #004080;
      transform: translateY(1px);
    }
    
    .export-pdf-btn:disabled{
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .timeStamp{
      font-weight: 700;
      margin-bottom: 4px;
      font-size: 10pt;
    }
    
    /* Firmas */
    .signatureSection{
      margin-top: 20px;
      border-top: 2px solid #000;
      padding-top: 10px;
    }
    .signatureTable{
      width: 100%;
      border-collapse: collapse;
    }
    .signatureCell{
      padding: 10px;
      vertical-align: top;
      width: 50%;
    }
    .signatureLine{
      border-top: 1px solid #000;
      margin-top: 40px;
      padding-top: 4px;
      font-size: 10pt;
      text-align: center;
    }
    
    /* Pie */
    .footerNote{
      margin-top: 15mm;
      font-size: 9pt;
      text-align: center;
      border-top: 1px solid #ccc;
      padding-top: 5px;
    }
    
    /* Impresi√≥n */
    @media print{
      .page{
        margin: 0;
        border: none;
      }
      body{
        background:#fff;
      }
      .logoPlaceholder,
      .imagePlaceholder{
        border: 1px solid #ddd;
      }
      .imagePlaceholder:hover{
        background-color: #f9f9f9;
        border-color: #ccc;
      }
      .date-input {
        -webkit-appearance: none;
        appearance: none;
      }
      .date-input::-webkit-calendar-picker-indicator {
        display: none;
      }
      .select-field{
        appearance: none;
        -webkit-appearance: none;
      }
      .text-input{
        border: none;
        background: transparent;
      }
      .cb{
        cursor: default;
      }
      .cb:hover{
        background-color: transparent;
      }
      .imagePlaceholder{
        cursor: default;
      }
      .remove-image-btn{
        display: none !important;
      }
      .export-section{
        display: none !important;
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="page-content">
      <table class="form" aria-label="Reporte de CCTV">
        <!-- Colgroup para estabilizar columnas -->
        <colgroup>
          <col style="width:20%">
          <col style="width:40%">
          <col style="width:15%">
          <col style="width:25%">
        </colgroup>
        
        <!-- Encabezado -->
        <tr class="rH1">
          <td class="logoCell">
            <div class="logoPlaceholder">Firma digital / Logo</div>
          </td>
          <td class="titleCell">REPORTE DE CCTV</td>
          <td class="metaCell" colspan="2">
            <table class="metaTable">
              <tr><td class="metaLabel">C√≥digo</td><td class="metaValue">RE PAC PO GS 4.4.6 31-01</td></tr>
              <tr><td class="metaLabel">Fecha del formulario</td><td class="metaValue">19-03-2018</td></tr>
              <tr><td class="metaLabel">Revisi√≥n</td><td class="metaValue">09</td></tr>
            </table>
          </td>
        </tr>

        <!-- Reportado por y Fecha de eventos -->
        <tr class="rowCompact">
          <td class="rowLabel">Reportado por</td>
          <td class="value">
            <select class="select-field" id="reportadoPor">
              <option value="" selected disabled>Choose an item.</option>
              <option>G. L√≥pez</option>
              <option>E. Sosa</option>
              <option>J. Castilla</option>
              <option>J. Mart√≠n</option>
            </select>
          </td>
          <td class="rowLabel" style="text-align:center;">Fecha de eventos</td>
          <td class="dateValueCell">
            <div class="date-input-container">
              <input type="date" id="fechaEventos" class="date-input" value="2026-01-28">
            </div>
          </td>
        </tr>

        <!-- Tipo de Reporte - CHECKBOXES INTERACTIVOS -->
        <tr>
          <td class="rowLabel">Tipo de Reporte</td>
          <td class="value" colspan="3">
            <div class="opts opts-spread">
              <span data-checkbox-group="tipoReporte" data-checkbox-value="caso">
                Caso <span class="cb" data-checkbox="tipoReporte-caso"></span>
              </span>
              <span data-checkbox-group="tipoReporte" data-checkbox-value="monitoreo">
                Monitoreo <span class="cb" data-checkbox="tipoReporte-monitoreo"></span>
              </span>
              <span data-checkbox-group="tipoReporte" data-checkbox-value="novedades">
                Novedades <span class="cb checked" data-checkbox="tipoReporte-novedades"></span>
              </span>
              <span data-checkbox-group="tipoReporte" data-checkbox-value="investigacion">
                Investigaci√≥n <span class="cb" data-checkbox="tipoReporte-investigacion"></span>
              </span>
              <span data-checkbox-group="tipoReporte" data-checkbox-value="auditoria">
                Auditor√≠a <span class="cb" data-checkbox="tipoReporte-auditoria"></span>
              </span>
            </div>
          </td>
        </tr>

        <!-- Sitio / Caso ID -->
        <tr>
          <td class="rowLabel">Sitio</td>
          <td class="value oneline">PLANTA PACHECO</td>
          <td class="rowLabel" style="text-align:center;">Caso ID</td>
          <td class="value oneline">
            <input type="text" id="casoId" class="text-input" value="CCTV-0004" maxlength="30" placeholder="Ingrese Caso ID">
          </td>
        </tr>

        <!-- Eventos registrados / √Årea - CHECKBOXES INTERACTIVOS -->
        <tr>
          <td class="rowLabel">1.- ¬øEventos Registrados?:</td>
          <td class="value">
            <div class="opts">
              <span data-checkbox-group="eventosRegistrados" data-checkbox-value="si">
                S√≠ <span class="cb checked" data-checkbox="eventosRegistrados-si"></span>
              </span>
              <span data-checkbox-group="eventosRegistrados" data-checkbox-value="no">
                No <span class="cb" data-checkbox="eventosRegistrados-no"></span>
              </span>
            </div>
          </td>
          <td class="rowLabel">2.- √Årea de los eventos:</td>
          <td class="value oneline">
            <input type="text" id="areaEventos" class="text-input" value="Interior Comedor de planta" maxlength="50" placeholder="Ingrese el √°rea">
          </td>
        </tr>

        <!-- Novedades -->
        <tr>
          <td class="sectionTitle" colspan="4">4.- Novedades:</td>
        </tr>
        <tr>
          <td class="bigBox" colspan="4">
            <ul>
              <li>Siendo las 0:13 ingresa al comedor y se retira 0:30</li>
              <li>Siendo 0:50 se dirige nuevamente al comedor y se queda hasta las 2:47 que regresa a su sector</li>
              <li>Siendo las 3:07 se dirige al comedor hasta las 3:37</li>
            </ul>
            
            <!-- Grid de im√°genes -->
            <table class="imageGrid">
              <!-- Primera fila de im√°genes -->
              <tr>
                <td class="imageCell">
                  <div class="timeStamp">0:13 Ingresa comedor</div>
                  <div class="imagePlaceholder" data-image-slot="1">
                    <span class="placeholder-text">Imagen CCTV</span>
                    <button class="remove-image-btn" data-remove-slot="1" title="Eliminar imagen">√ó</button>
                    <input type="file" accept="image/png, image/jpeg, image/jpg" data-image-input="1">
                  </div>
                </td>
                <td class="imageCell">
                  <div class="timeStamp">0:17 continua en el comedor</div>
                  <div class="imagePlaceholder" data-image-slot="2">
                    <span class="placeholder-text">Imagen CCTV</span>
                    <button class="remove-image-btn" data-remove-slot="2" title="Eliminar imagen">√ó</button>
                    <input type="file" accept="image/png, image/jpeg, image/jpg" data-image-input="2">
                  </div>
                </td>
                <td class="imageCell">
                  <div class="timeStamp">0:30 regresa a su sector</div>
                  <div class="imagePlaceholder" data-image-slot="3">
                    <span class="placeholder-text">Imagen CCTV</span>
                    <button class="remove-image-btn" data-remove-slot="3" title="Eliminar imagen">√ó</button>
                    <input type="file" accept="image/png, image/jpeg, image/jpg" data-image-input="3">
                  </div>
                </td>
              </tr>
              <!-- Segunda fila de im√°genes -->
              <tr>
                <td class="imageCell">
                  <div class="timeStamp">0:50 se dirige al comedor</div>
                  <div class="imagePlaceholder" data-image-slot="4">
                    <span class="placeholder-text">Imagen CCTV</span>
                    <button class="remove-image-btn" data-remove-slot="4" title="Eliminar imagen">√ó</button>
                    <input type="file" accept="image/png, image/jpeg, image/jpg" data-image-input="4">
                  </div>
                </td>
                <td class="imageCell">
                  <div class="timeStamp">1:23 en el comedor</div>
                  <div class="imagePlaceholder" data-image-slot="5">
                    <span class="placeholder-text">Imagen CCTV</span>
                    <button class="remove-image-btn" data-remove-slot="5" title="Eliminar imagen">√ó</button>
                    <input type="file" accept="image/png, image/jpeg, image/jpg" data-image-input="5">
                  </div>
                </td>
                <td class="imageCell">
                  <div class="timeStamp">2:47 regresa a su sector</div>
                  <div class="imagePlaceholder" data-image-slot="6">
                    <span class="placeholder-text">Imagen CCTV</span>
                    <button class="remove-image-btn" data-remove-slot="6" title="Eliminar imagen">√ó</button>
                    <input type="file" accept="image/png, image/jpeg, image/jpg" data-image-input="6">
                  </div>
                </td>
              </tr>
              <!-- Tercera fila de im√°genes -->
              <tr>
                <td class="imageCell">
                  <div class="timeStamp">3:07 se dirige al comedor</div>
                  <div class="imagePlaceholder" data-image-slot="7">
                    <span class="placeholder-text">Imagen CCTV</span>
                    <button class="remove-image-btn" data-remove-slot="7" title="Eliminar imagen">√ó</button>
                    <input type="file" accept="image/png, image/jpeg, image/jpg" data-image-input="7">
                  </div>
                </td>
                <td class="imageCell">
                  <div class="timeStamp">3:20 se encuentra en el comedor</div>
                  <div class="imagePlaceholder" data-image-slot="8">
                    <span class="placeholder-text">Imagen CCTV</span>
                    <button class="remove-image-btn" data-remove-slot="8" title="Eliminar imagen">√ó</button>
                    <input type="file" accept="image/png, image/jpeg, image/jpg" data-image-input="8">
                  </div>
                </td>
                <td class="imageCell">
                  <div class="timeStamp">3:37 regresa a su sector</div>
                  <div class="imagePlaceholder" data-image-slot="9">
                    <span class="placeholder-text">Imagen CCTV</span>
                    <button class="remove-image-btn" data-remove-slot="9" title="Eliminar imagen">√ó</button>
                    <input type="file" accept="image/png, image/jpeg, image/jpg" data-image-input="9">
                  </div>
                </td>
              </tr>
            </table>
          </td>
        </tr>
      </table>

      <!-- Secci√≥n de firmas -->
      <div class="signatureSection">
        <table class="signatureTable">
          <tr>
            <td class="signatureCell">
              <div class="signatureLine">
                Reporte generado por<br>
                <span id="reporteGeneradoPor">Choose an item.</span>
              </div>
            </td>
            <td class="signatureCell">
              <div class="signatureLine">
                Reporte revisado por<br>
                G. LOPEZ
              </div>
            </td>
          </tr>
        </table>
      </div>

      <!-- Bot√≥n de exportar a PDF -->
      <div class="export-section">
        <button id="exportPdfBtn" class="export-pdf-btn">üìÑ Exportar a PDF</button>
      </div>

      <div class="footerNote">Mondelez International Internal ‚Äî Uso exclusivo</div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Configurar t√≠tulo del input de fecha
      const fechaInput = document.getElementById('fechaEventos');
      fechaInput.title = 'Haz clic para seleccionar una fecha';

      // ========== SINCRONIZACI√ìN REPORTADO POR ==========
      const reportadoPorSelect = document.getElementById('reportadoPor');
      const reporteGeneradoPorSpan = document.getElementById('reporteGeneradoPor');
      
      // Sincronizar cuando cambia la selecci√≥n
      reportadoPorSelect.addEventListener('change', () => {
        const selectedValue = reportadoPorSelect.value;
        reporteGeneradoPorSpan.textContent = selectedValue || 'Choose an item.';
        console.log('Reportado por actualizado:', selectedValue);
      });

      // ========== MANEJO DE IM√ÅGENES ==========
      const imagePlaceholders = document.querySelectorAll('.imagePlaceholder');
      
      imagePlaceholders.forEach(placeholder => {
        const fileInput = placeholder.querySelector('input[type="file"]');
        const removeBtn = placeholder.querySelector('.remove-image-btn');
        const slotNumber = placeholder.dataset.imageSlot;
        
        // Al hacer click en el placeholder (pero no en el bot√≥n de eliminar)
        placeholder.addEventListener('click', (e) => {
          // Si el click fue en el bot√≥n de eliminar, no abrir selector
          if (e.target.classList.contains('remove-image-btn')) {
            return;
          }
          fileInput.click();
        });
        
        // Cuando se selecciona un archivo
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          
          if (file && (file.type === 'image/png' || file.type === 'image/jpeg' || file.type === 'image/jpg')) {
            const reader = new FileReader();
            
            reader.onload = (event) => {
              // Ocultar el texto placeholder
              const placeholderText = placeholder.querySelector('.placeholder-text');
              if (placeholderText) {
                placeholderText.style.display = 'none';
              }
              
              // Verificar si ya existe una imagen
              let img = placeholder.querySelector('img');
              if (!img) {
                img = document.createElement('img');
                placeholder.appendChild(img);
              }
              
              // Establecer la imagen
              img.src = event.target.result;
              placeholder.classList.add('has-image');
              
              console.log(`Imagen cargada en slot ${slotNumber}: ${file.name}`);
            };
            
            reader.readAsDataURL(file);
          } else {
            alert('Por favor, selecciona solo archivos PNG o JPG');
            fileInput.value = '';
          }
        });
        
        // Funci√≥n para eliminar imagen
        removeBtn.addEventListener('click', (e) => {
          e.stopPropagation(); // Evitar que se abra el selector de archivos
          
          // Eliminar la imagen
          const img = placeholder.querySelector('img');
          if (img) {
            img.remove();
          }
          
          // Mostrar nuevamente el texto placeholder
          const placeholderText = placeholder.querySelector('.placeholder-text');
          if (placeholderText) {
            placeholderText.style.display = 'block';
          }
          
          // Remover la clase has-image
          placeholder.classList.remove('has-image');
          
          // Resetear el input file
          fileInput.value = '';
          
          console.log(`Imagen eliminada del slot ${slotNumber}`);
        });
      });

      // ========== CHECKBOXES INTERACTIVOS ==========
      // Funci√≥n para manejar checkboxes con exclusi√≥n mutua
      function setupCheckboxGroup(groupName) {
        const groupItems = document.querySelectorAll(`[data-checkbox-group="${groupName}"]`);
        
        groupItems.forEach(item => {
          const checkbox = item.querySelector('.cb');
          const value = item.dataset.checkboxValue;
          
          // Hacer clickeable tanto el span como el checkbox
          item.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Desmarcar todos los checkboxes del grupo
            groupItems.forEach(otherItem => {
              otherItem.querySelector('.cb').classList.remove('checked');
            });
            
            // Marcar el checkbox clickeado
            checkbox.classList.add('checked');
            
            // Log para debugging (opcional)
            console.log(`${groupName}: ${value} seleccionado`);
          });
        });
      }

      // Inicializar grupos de checkboxes
      setupCheckboxGroup('tipoReporte');
      setupCheckboxGroup('eventosRegistrados');

      // ========== EXPORTAR A PDF ==========
      const exportPdfBtn = document.getElementById('exportPdfBtn');
      
      exportPdfBtn.addEventListener('click', async () => {
        // Deshabilitar el bot√≥n mientras se genera el PDF
        exportPdfBtn.disabled = true;
        exportPdfBtn.textContent = '‚è≥ Generando PDF...';
        
        try {
          // Ocultar temporalmente el bot√≥n de exportar y los botones de eliminar
          const exportSection = document.querySelector('.export-section');
          const removeButtons = document.querySelectorAll('.remove-image-btn');
          
          exportSection.style.display = 'none';
          removeButtons.forEach(btn => btn.style.display = 'none');
          
          // Capturar el contenido de la p√°gina
          const pageElement = document.querySelector('.page');
          
          const canvas = await html2canvas(pageElement, {
            scale: 2, // Mayor calidad
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff'
          });
          
          // Crear PDF
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
          });
          
          // Calcular dimensiones para ajustar al A4
          const imgWidth = 210; // A4 width in mm
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          
          // Agregar imagen al PDF
          const imgData = canvas.toDataURL('image/png');
          pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
          
          // Generar nombre de archivo con fecha y caso ID
          const casoId = document.getElementById('casoId').value || 'CCTV';
          const fecha = document.getElementById('fechaEventos').value || new Date().toISOString().split('T')[0];
          const fileName = `Reporte_CCTV_${casoId}_${fecha}.pdf`;
          
          // Descargar el PDF
          pdf.save(fileName);
          
          console.log('PDF generado exitosamente:', fileName);
          
          // Mostrar nuevamente los elementos ocultos
          exportSection.style.display = 'block';
          removeButtons.forEach(btn => btn.style.display = '');
          
        } catch (error) {
          console.error('Error al generar PDF:', error);
          alert('Hubo un error al generar el PDF. Por favor, intenta nuevamente.');
        } finally {
          // Rehabilitar el bot√≥n
          exportPdfBtn.disabled = false;
          exportPdfBtn.textContent = 'üìÑ Exportar a PDF';
        }
      });

      // ========== FUNCI√ìN PARA OBTENER DATOS DEL FORMULARIO ==========
      window.getFormData = function() {
        const data = {
          reportadoPor: reportadoPorSelect.value,
          fechaEventos: fechaInput.value,
          tipoReporte: null,
          eventosRegistrados: null,
          sitio: 'PLANTA PACHECO',
          casoId: document.getElementById('casoId').value,
          areaEventos: document.getElementById('areaEventos').value,
          imagenes: {}
        };

        // Obtener tipo de reporte seleccionado
        const tipoReporteChecked = document.querySelector('[data-checkbox-group="tipoReporte"] .cb.checked');
        if (tipoReporteChecked) {
          data.tipoReporte = tipoReporteChecked.parentElement.dataset.checkboxValue;
        }

        // Obtener eventos registrados
        const eventosChecked = document.querySelector('[data-checkbox-group="eventosRegistrados"] .cb.checked');
        if (eventosChecked) {
          data.eventosRegistrados = eventosChecked.parentElement.dataset.checkboxValue;
        }

        // Obtener informaci√≥n de im√°genes cargadas
        imagePlaceholders.forEach(placeholder => {
          const slotNumber = placeholder.dataset.imageSlot;
          const img = placeholder.querySelector('img');
          const fileInput = placeholder.querySelector('input[type="file"]');
          
          if (img && img.src) {
            data.imagenes[`slot${slotNumber}`] = {
              loaded: true,
              fileName: fileInput.files[0] ? fileInput.files[0].name : 'unknown',
              dataUrl: img.src
            };
          } else {
            data.imagenes[`slot${slotNumber}`] = {
              loaded: false
            };
          }
        });

        return data;
      };

      // Para testing - mostrar datos en consola al cambiar valores
      reportadoPorSelect.addEventListener('change', () => {
        console.log('Datos del formulario:', window.getFormData());
      });

      fechaInput.addEventListener('change', () => {
        console.log('Datos del formulario:', window.getFormData());
      });
      
      document.getElementById('areaEventos').addEventListener('change', () => {
        console.log('Datos del formulario:', window.getFormData());
      });
      
      document.getElementById('casoId').addEventListener('change', () => {
        console.log('Datos del formulario:', window.getFormData());
      });
    });
  </script>
</body>
</html>
